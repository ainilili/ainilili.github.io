<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="zh-Hans">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT">










<meta name="description" content="我是Nico，梦想是做一名兴趣使然的码农，于是我一步步变强，后来我成为了光头">
<meta name="keywords" content="“博客,Java,Python,Node,开源,框架,并发,Mysql”">
<meta property="og:type" content="website">
<meta property="og:title" content="Nico&#39;s Blog">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="Nico&#39;s Blog">
<meta property="og:description" content="我是Nico，梦想是做一名兴趣使然的码农，于是我一步步变强，后来我成为了光头">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Nico&#39;s Blog">
<meta name="twitter:description" content="我是Nico，梦想是做一名兴趣使然的码农，于是我一步步变强，后来我成为了光头">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/">





  <title>Nico's Blog</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Nico's Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">兴趣使然的Coder</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br>
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            归档
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2021/03/22/Kick-Start-Round-A-2021-L-Shaped-Plots/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Nico">
      <meta itemprop="description" content>
      <meta itemprop="image" content="https://avatars1.githubusercontent.com/u/26395860?s=460&v=4">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Nico's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2021/03/22/Kick-Start-Round-A-2021-L-Shaped-Plots/" itemprop="url">Kick Start Round A 2021 -  L Shaped Plots </a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-03-22T04:01:00+08:00">
                2021-03-22
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Algorithm/" itemprop="url" rel="index">
                    <span itemprop="name">Algorithm</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>原题地址: <a href="https://codingcompetitions.withgoogle.com/kickstart/round/0000000000436140/000000000068c509" target="_blank" rel="noopener">传送门</a></p>
<h3 id="分析"><a class="header-anchor" href="#分析">¶</a>分析</h3>
<p>在二维坐标系中由很多坐标点组成段，段的最小长度为2，且段只有x轴（横轴）和y轴（纵轴）之分，求由两个段组成，垂直有共同顶点，且长边是短边两倍的组合数量。</p>
<p>输入集是一个二维数组，要求中的两个线段互相垂直，这里可以分析出组合中的两个线段一个在x轴一个在y轴。一种思路是通过遍历二维数组得到x和y轴所有的段，再对每个段的端点做索引，再做dfs求组合数，不过这种简单的思路在Test2会出现超时或内存溢出的错误，所以要换一种更简单的思路。</p>
<p>个人解决思路是先对x或y任意维度做head的索引（y轴由上到下，head为上顶点，x轴head为左顶点），例如先对y轴所有段的head做索引，这里直接使用二维数组，假设y轴段的索引定义为二维数组<code>indexs = [1000][1000]int</code>, indexs第一层下标为x轴坐标，第二层下标为y轴坐标，值为段的长度。之后再遍历获取所有的x轴段，对于x轴的每个段，取其对应的head和tail坐标以及长度len，通过枚举所有满足的y轴坐标值：</p>
<ul>
<li>y1 (head.x, head.y - （len/2） + 1)</li>
<li>y2 (head.x, head.y)</li>
<li>y3 (head.x, head.y - （len*2） + 1)</li>
<li>y4 (tail.x, tail.y - （len/2） + 1)</li>
<li>y5 (tail.x, tail.y)</li>
<li>y6 (tail.x, tail.y - （len*2） + 1)</li>
</ul>
<p>(y1和y4只有当len为偶数且大于等于4的时候才成立)<br>
之后通过得到的y轴坐标去检索indexs，如果存在则判断对应段的长度是否满足与当前x轴段长的规则，如果满足则count ++，所有x轴段匹配完毕，输出count为结果值。</p>
<h3 id="slove"><a class="header-anchor" href="#slove">¶</a>Slove</h3>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">"bufio"</span></span><br><span class="line">	<span class="string">"fmt"</span></span><br><span class="line">	<span class="string">"os"</span></span><br><span class="line">	<span class="string">"strconv"</span></span><br><span class="line">	<span class="string">"strings"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> res = <span class="built_in">make</span>([]<span class="keyword">int</span>, <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> in = bufio.NewReader(os.Stdin)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">solve</span><span class="params">()</span></span>&#123;</span><br><span class="line">	inputs := readInts(in)</span><br><span class="line">	r := inputs[<span class="number">0</span>]</span><br><span class="line">	c := inputs[<span class="number">1</span>]</span><br><span class="line">	grid := <span class="built_in">make</span>([][]<span class="keyword">int</span>, r)</span><br><span class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; r; i ++ &#123;</span><br><span class="line">		grid[i] = readInts(in)</span><br><span class="line">	&#125;</span><br><span class="line">	cols := [<span class="number">1000</span>][<span class="number">1000</span>]<span class="keyword">int</span>&#123;&#125;</span><br><span class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; c; i ++ &#123;</span><br><span class="line">		y := <span class="number">-1</span></span><br><span class="line">		<span class="keyword">for</span> j := <span class="number">0</span>; j &lt; r;	j ++  &#123;</span><br><span class="line">			<span class="keyword">if</span> grid[j][i] == <span class="number">1</span>&#123;</span><br><span class="line">				<span class="keyword">if</span> y == <span class="number">-1</span> &#123;</span><br><span class="line">					y = j</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">if</span> y != <span class="number">-1</span> &amp;&amp; (grid[j][i] != <span class="number">1</span>  || j == r - <span class="number">1</span>)&#123;</span><br><span class="line">				d := j - y</span><br><span class="line">				<span class="keyword">if</span> j == r - <span class="number">1</span> &amp;&amp; grid[j][i] == <span class="number">1</span>&#123;</span><br><span class="line">					d ++</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">if</span> d &gt; <span class="number">1</span> &#123;</span><br><span class="line">					<span class="keyword">for</span> di := <span class="number">0</span>; di &lt; d; di ++ &#123;</span><br><span class="line">						<span class="keyword">for</span> dj := di + <span class="number">1</span>; dj &lt; d;  dj ++&#123;</span><br><span class="line">							cols[i][y + di] = dj - di + <span class="number">1</span></span><br><span class="line">						&#125;</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">				y = <span class="number">-1</span></span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	count := <span class="number">0</span></span><br><span class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; r; i ++ &#123;</span><br><span class="line">		x := <span class="number">-1</span></span><br><span class="line">		<span class="keyword">for</span> j := <span class="number">0</span>; j &lt; c;	j ++  &#123;</span><br><span class="line">			<span class="keyword">if</span> grid[i][j] == <span class="number">1</span>&#123;</span><br><span class="line">				<span class="keyword">if</span> x == <span class="number">-1</span> &#123;</span><br><span class="line">					x = j</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">if</span> x != <span class="number">-1</span> &amp;&amp;(grid[i][j] != <span class="number">1</span>  || j == c - <span class="number">1</span>)&#123;</span><br><span class="line">				d := j - x</span><br><span class="line">				<span class="keyword">if</span> j == c - <span class="number">1</span> &amp;&amp; grid[i][j] == <span class="number">1</span>&#123;</span><br><span class="line">					d ++</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">if</span> d &gt; <span class="number">1</span> &#123;</span><br><span class="line">					<span class="keyword">for</span> di := <span class="number">0</span>; di &lt; d; di ++ &#123;</span><br><span class="line">						<span class="keyword">for</span> dj := di + <span class="number">1</span>; dj &lt; d;  dj ++&#123;</span><br><span class="line">							hx := x + di</span><br><span class="line">							hy := i</span><br><span class="line">							tx := x + dj</span><br><span class="line">							ty := i</span><br><span class="line">							l := dj - di + <span class="number">1</span></span><br><span class="line"></span><br><span class="line">							<span class="keyword">if</span> l % <span class="number">2</span> == <span class="number">0</span> &amp;&amp; l &gt;= <span class="number">4</span>&#123;</span><br><span class="line">								chy := hy - l / <span class="number">2</span> + <span class="number">1</span></span><br><span class="line">								cty := ty - l / <span class="number">2</span> + <span class="number">1</span></span><br><span class="line">								<span class="keyword">if</span> chy &gt;= <span class="number">0</span> &#123;</span><br><span class="line">									<span class="keyword">if</span> n := cols[hx][chy]; n &gt;= l / <span class="number">2</span>&#123;</span><br><span class="line">										count ++</span><br><span class="line">									&#125;</span><br><span class="line">								&#125;</span><br><span class="line">								<span class="keyword">if</span> n := cols[hx][hy]; n &gt;= l / <span class="number">2</span> &#123;</span><br><span class="line">									count ++</span><br><span class="line">								&#125;</span><br><span class="line">								<span class="keyword">if</span> cty &gt;= <span class="number">0</span> &#123;</span><br><span class="line">									<span class="keyword">if</span> n := cols[tx][cty]; n &gt;= l / <span class="number">2</span>&#123;</span><br><span class="line">										count ++</span><br><span class="line">									&#125;</span><br><span class="line">								&#125;</span><br><span class="line">								<span class="keyword">if</span> n := cols[tx][ty]; n &gt;= l / <span class="number">2</span> &#123;</span><br><span class="line">									count ++</span><br><span class="line">								&#125;</span><br><span class="line">							&#125;</span><br><span class="line">							chy := hy - l * <span class="number">2</span> + <span class="number">1</span></span><br><span class="line">							cty := ty - l * <span class="number">2</span> + <span class="number">1</span></span><br><span class="line">							<span class="keyword">if</span> chy &gt;= <span class="number">0</span> &#123;</span><br><span class="line">								<span class="keyword">if</span> n := cols[hx][chy]; n &gt;= l * <span class="number">2</span> &#123;</span><br><span class="line">									count ++</span><br><span class="line">								&#125;</span><br><span class="line">							&#125;</span><br><span class="line">							<span class="keyword">if</span> n := cols[hx][hy]; n &gt;= l * <span class="number">2</span> &#123;</span><br><span class="line">								count ++</span><br><span class="line">							&#125;</span><br><span class="line">							<span class="keyword">if</span> cty &gt;= <span class="number">0</span> &#123;</span><br><span class="line">								<span class="keyword">if</span> n := cols[tx][cty]; n &gt;= l * <span class="number">2</span> &#123;</span><br><span class="line">									count ++</span><br><span class="line">								&#125;</span><br><span class="line">							&#125;</span><br><span class="line">							<span class="keyword">if</span> n := cols[tx][ty]; n &gt;= l * <span class="number">2</span> &#123;</span><br><span class="line">								count ++</span><br><span class="line">							&#125;</span><br><span class="line">						&#125;</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">				x = <span class="number">-1</span></span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	res = <span class="built_in">append</span>(res, count)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span>  &#123;</span><br><span class="line">	t := readInts(in)[<span class="number">0</span>]</span><br><span class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; t; i ++ &#123;</span><br><span class="line">		solve()</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">for</span> i, v := <span class="keyword">range</span> res &#123;</span><br><span class="line">		fmt.Printf(<span class="string">"Case #%d: %d\n"</span>, i + <span class="number">1</span>, v)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">readline</span><span class="params">(in *bufio.Reader)</span> <span class="title">string</span></span>&#123;</span><br><span class="line">	line, _ := in.ReadString(<span class="string">'\n'</span>)</span><br><span class="line">	<span class="keyword">return</span> line[<span class="number">0</span>:<span class="built_in">len</span>(line) - <span class="number">1</span>]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">readInts</span><span class="params">(in *bufio.Reader)</span> []<span class="title">int</span></span>&#123;</span><br><span class="line">	line := readline(in)</span><br><span class="line">	arr := strings.Split(line, <span class="string">" "</span>)</span><br><span class="line">	res := <span class="built_in">make</span>([]<span class="keyword">int</span>, <span class="number">0</span>)</span><br><span class="line">	<span class="keyword">for</span> _, str := <span class="keyword">range</span> arr &#123;</span><br><span class="line">		v, _ := strconv.ParseInt(str, <span class="number">10</span>, <span class="number">64</span>)</span><br><span class="line">		res = <span class="built_in">append</span>(res, <span class="keyword">int</span>(v))</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> res</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2021/03/22/Kick-Start-Round-A-2021-K-Goodness-String/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Nico">
      <meta itemprop="description" content>
      <meta itemprop="image" content="https://avatars1.githubusercontent.com/u/26395860?s=460&v=4">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Nico's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2021/03/22/Kick-Start-Round-A-2021-K-Goodness-String/" itemprop="url">Kick Start Round A 2021 -  K-Goodness String</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-03-22T02:37:00+08:00">
                2021-03-22
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Algorithm/" itemprop="url" rel="index">
                    <span itemprop="name">Algorithm</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>原题地址: <a href="https://codingcompetitions.withgoogle.com/kickstart/round/0000000000436140/000000000068cca3#problem" target="_blank" rel="noopener">传送门</a></p>
<h3 id="分析"><a class="header-anchor" href="#分析">¶</a>分析</h3>
<p>题意大概是当字符串对称位置的字母如果不相同则score加一分，输入字符串以及期望的score分数，求将当前字符串变动任意位置的字母使之score等于期望的socre。</p>
<p>其实就是求字符串对称位置字符不相同的数量，然后和期望score做差再取abs。</p>
<h3 id="slove"><a class="header-anchor" href="#slove">¶</a>Slove</h3>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">"bufio"</span></span><br><span class="line">	<span class="string">"fmt"</span></span><br><span class="line">	<span class="string">"os"</span></span><br><span class="line">	<span class="string">"strconv"</span></span><br><span class="line">	<span class="string">"strings"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> res = <span class="built_in">make</span>([]<span class="keyword">int</span>, <span class="number">0</span>)</span><br><span class="line"><span class="keyword">var</span> in = bufio.NewReader(os.Stdin)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">solve</span><span class="params">()</span></span>&#123;</span><br><span class="line">	inputs := readInts(in)</span><br><span class="line">	n := inputs[<span class="number">0</span>]</span><br><span class="line">	k := inputs[<span class="number">1</span>]</span><br><span class="line">	str := readline(in)</span><br><span class="line">	s := <span class="number">0</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="built_in">len</span>(str); i++ &#123;</span><br><span class="line">		r := n - <span class="number">1</span> - i</span><br><span class="line">		<span class="keyword">if</span> r &lt;= i &#123;</span><br><span class="line">			<span class="keyword">break</span></span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> str[i] != str[r] &#123;</span><br><span class="line">			s ++</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	result := k - s</span><br><span class="line">	<span class="keyword">if</span> result &lt; <span class="number">0</span>&#123;</span><br><span class="line">		result = - result</span><br><span class="line">	&#125;</span><br><span class="line">	res = <span class="built_in">append</span>(res, result)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span>  &#123;</span><br><span class="line">	t := readInts(in)[<span class="number">0</span>]</span><br><span class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; t; i ++ &#123;</span><br><span class="line">		solve()</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">for</span> i, v := <span class="keyword">range</span> res &#123;</span><br><span class="line">		fmt.Printf(<span class="string">"Case #%d: %d\n"</span>, i + <span class="number">1</span>, v)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">readline</span><span class="params">(in *bufio.Reader)</span> <span class="title">string</span></span>&#123;</span><br><span class="line">	line, _ := in.ReadString(<span class="string">'\n'</span>)</span><br><span class="line">	<span class="keyword">return</span> line[<span class="number">0</span>:<span class="built_in">len</span>(line) - <span class="number">1</span>]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">readInts</span><span class="params">(in *bufio.Reader)</span> []<span class="title">int</span></span>&#123;</span><br><span class="line">	line := readline(in)</span><br><span class="line">	arr := strings.Split(line, <span class="string">" "</span>)</span><br><span class="line">	res := <span class="built_in">make</span>([]<span class="keyword">int</span>, <span class="number">0</span>)</span><br><span class="line">	<span class="keyword">for</span> _, str := <span class="keyword">range</span> arr &#123;</span><br><span class="line">		v, _ := strconv.ParseInt(str, <span class="number">10</span>, <span class="number">64</span>)</span><br><span class="line">		res = <span class="built_in">append</span>(res, <span class="keyword">int</span>(v))</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> res</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/05/26/如何设计并实现一个db连接池？/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Nico">
      <meta itemprop="description" content>
      <meta itemprop="image" content="https://avatars1.githubusercontent.com/u/26395860?s=460&v=4">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Nico's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/05/26/如何设计并实现一个db连接池？/" itemprop="url">如何设计并实现一个db连接池？</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-05-26T13:42:00+08:00">
                2019-05-26
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="连接池的使命"><a class="header-anchor" href="#连接池的使命">¶</a>连接池的使命！</h2>
<p>无论是线程池还是db连接池，他们都有一个共同的特性：<strong>资源复用</strong>，在普通的场景中，我们使用一个连接，它的生命周期可能是这样的：<br>
<img src="https://user-gold-cdn.xitu.io/2019/5/24/16ae8d822d4ac11e?w=637&amp;h=168&amp;f=png&amp;s=4758" alt><br>
一个连接，从创建完毕到销毁，期间只被使用了一次（这里的一次是指在单个作用域内的使用），当周期结束，另外一个调用者仍然需要这个连接去做事，就要重复去经历这种生命周期。因为创建和销毁都是需要对应的服务消耗时间以及系统资源去处理的，这样不仅浪费了大量的系统资源，而且导致业务响应过程中都要花费部分时间去重复的创建和销毁，得不偿失，而连接池便被赋予了解决这种问题的使命！</p>
<h2 id="连接池需要做什么？"><a class="header-anchor" href="#连接池需要做什么？">¶</a>连接池需要做什么？</h2>
<p>顾名思义，连接池中的<strong>池</strong>字已经很生动形象的阐明了它的用意，它用将所有连接放入一个<code>&quot;池子&quot;</code>中统一的去控制连接的创建和销毁，和原始生命周期去对比，连接池多了以下特性：</p>
<ul>
<li>创建并不是真的创建，而是从池子中选出空闲连接。</li>
<li>销毁并不是真的销毁，而是将使用中的连接放回池中（逻辑关闭）。</li>
<li>真正的创建和销毁由线程池的特性机制来决定。</li>
</ul>
<p>因此，当使用连接池后，我们使用一个连接的生命周期将会演变成这样：<br>
<img src="https://user-gold-cdn.xitu.io/2019/5/24/16ae8fb43b0a3d13?w=588&amp;h=377&amp;f=png&amp;s=13088" alt></p>
<h2 id="分析计划"><a class="header-anchor" href="#分析计划">¶</a>分析计划</h2>
<p>通灵之术 - 传送门：<a href="https://github.com/ainilili/honeycomb" target="_blank" rel="noopener">https://github.com/ainilili/honeycomb</a>，DEMO为Java语言实现！</p>
<p>事前，我们需要点支烟分析一下时间一个连接池需要做哪些事情：</p>
<ul>
<li>保存连接的容器是必不可少的，另外，该容器也要支持连接的添加和移除功能，并保证线程安全。</li>
<li>我们需要因为要对连接的销毁做逻辑调整，我们需要重写它的<code>close</code>以及<code>isClosed</code>方法。</li>
<li>我们需要有个入口对连接池做管理，例如回收空闲连接。</li>
</ul>
<p>连接池不仅仅只是对<code>Connection</code>生命周期的控制，还应该加入一些特色，例如初始连接数，最大连接数，最小连接数、最大空闲时长以及获取连接的等待时长，这些我们也简单支持一下。</p>
<p>目标以明确，开始动工。</p>
<h3 id="连接池容器选型"><a class="header-anchor" href="#连接池容器选型">¶</a>连接池容器选型</h3>
<p>要保证线程安全，我们可以将目标瞄准在<code>JUC</code>包下的神通们，设我们想要的容器为<code>x</code>，那么<code>x</code>不仅需要满足基本的增删改查功能，而且也要提供获取超时功能，这是为了保证当池内长时间没有空闲连接时不会导致业务阻塞，即刻熔断。另外，<code>x</code>需要满足双向操作，这是为了连接池可以识别出饱和的空闲连接，方便回收操作。</p>
<p>综上所述，<code>LinkedBlockingDeque</code>是最合适的选择，它使用<code>InterruptibleReentrantLock</code>来保证线程安全，使用<code>Condition</code>来做获取元素的阻塞，另外支持双向操作。</p>
<p>另外，我们可以将连接池拆分为3个类型：</p>
<ul>
<li><strong>工作池</strong>：存放正在被使用的连接。</li>
<li><strong>空闲池</strong>：存放空闲连接。</li>
<li><strong>回收池</strong>：已经被回收（物理关闭）的连接。</li>
</ul>
<p>其中，<strong>工作池</strong>和<strong>回收池</strong>大可不必用双向对列，或许用单向队列或者<code>Set</code>都可以代替之：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> LinkedBlockingQueue&lt;HoneycombConnection&gt; workQueue;</span><br><span class="line"><span class="keyword">private</span> LinkedBlockingDeque&lt;HoneycombConnection&gt; idleQueue;</span><br><span class="line"><span class="keyword">private</span> LinkedBlockingQueue&lt;HoneycombConnection&gt; freezeQueue;</span><br></pre></td></tr></table></figure>
<h3 id="connection的装饰"><a class="header-anchor" href="#connection的装饰">¶</a>Connection的装饰</h3>
<p>连接池的输出是<code>Connection</code>，它代表着一个db连接，上游服务使用它做完操作后，会直接调用它的<code>close</code>方法来释放连接，而我们必须做的是在调用者无感知的情况下改变它的关闭逻辑，当调用<code>close</code>的方法时，我们将它放回空闲队列中，保证其的可复用性！</p>
<p>因此，我们需要对原来的<code>Connection</code>做装饰，其做法很简单，但是很累，这里新建一个类来实现<code>Connection</code>接口，通过重写所有的方法来实现一个**“可编辑”**的<code>Connection</code>，我们称之为<code>Connection</code>的装饰者：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HoneycombConnectionDecorator</span> <span class="keyword">implements</span> <span class="title">Connection</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> Connection connection;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="title">HoneycombConnectionDecorator</span><span class="params">(Connection connection)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.connection = connection;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    此处省略对方法实现的三百行代码...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>之后，我们需要新建一个自己的<code>Connection</code>来继承这个装饰者，并重写相应的方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HoneycombConnection</span> <span class="keyword">extends</span> <span class="title">HoneycombConnectionDecorator</span> <span class="keyword">implements</span> <span class="title">HoneycombConnectionSwitcher</span></span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">close</span><span class="params">()</span> </span>&#123; <span class="keyword">do</span> some things &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isClosed</span><span class="params">()</span> <span class="keyword">throws</span> SQLException </span>&#123; <span class="keyword">do</span> some things &#125;    </span><br><span class="line">    </span><br><span class="line">    省略...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="datasource的重写"><a class="header-anchor" href="#datasource的重写">¶</a>DataSource的重写</h3>
<p><code>DataSource</code>是JDK为了更好的统合和管理数据源而定义出的一个规范，获取连接的入口，方便我们在这一层更好的扩展数据源（例如增加特殊属性），使我们的连接池的功能更加丰富，我们需要实现一个自己的<code>DataSource</code>能：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HoneycombWrapperDatasource</span> <span class="keyword">implements</span> <span class="title">DataSource</span></span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> HoneycombDatasourceConfig config;</span><br><span class="line">    省略其它方法的实现...</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Connection <span class="title">getConnection</span><span class="params">()</span> <span class="keyword">throws</span> SQLException </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> DriverManager.getConnection(config.getUrl(), config.getUser(), config.getPassword());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Connection <span class="title">getConnection</span><span class="params">(String username, String password)</span> <span class="keyword">throws</span> SQLException </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> DriverManager.getConnection(config.getUrl(), username, password);</span><br><span class="line">    &#125;</span><br><span class="line">    省略其它方法的实现...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们完成了对数据源的实现，但是这里获取连接的方式是物理创建，我们需要满足池化的目的，需要重写<code>HoneycombWrapperDatasource</code>中的连接获取逻辑，做法是创建一个新的类对父类方法重写：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HoneycombDataSource</span> <span class="keyword">extends</span> <span class="title">HoneycombWrapperDatasource</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> HoneycombConnectionPool pool;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Connection <span class="title">getConnection</span><span class="params">()</span> <span class="keyword">throws</span> SQLException </span>&#123;</span><br><span class="line">        这里实现从pool中取出连接的逻辑</span><br><span class="line">    &#125;</span><br><span class="line">    省略...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="特性扩展"><a class="header-anchor" href="#特性扩展">¶</a>特性扩展</h3>
<p>在当前结构体系下，我们的连接池逐渐浮现出了雏形，但远远不够的是，我们需要在此结构下可以做自由的扩展，使连接池对连接的控制更加灵活，因此我们可以引入<strong>特性</strong>这个概念，它允许我们在其内部访问连接池，并对连接池做一系列的扩展操作：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractFeature</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">doing</span><span class="params">(HoneycombConnectionPool pool)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>AbstractFeature</code>抽象父类需要实现<code>doing</code>方法，我们可以在方法内部实现对连接池的控制，其中一个典型的例子就是对池中空闲连接左回收：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CleanerFeature</span> <span class="keyword">extends</span> <span class="title">AbstractFeature</span></span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doing</span><span class="params">(HoneycombConnectionPool pool)</span> </span>&#123;</span><br><span class="line">        这里做空闲连接的回收</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="落实计划"><a class="header-anchor" href="#落实计划">¶</a>落实计划</h2>
<p>经过上述分析，要完成一个连接池，需要这些模块的配合，总体流程如下：<br>
<img src="https://user-gold-cdn.xitu.io/2019/5/26/16af28f6f668a3e6?w=754&amp;h=845&amp;f=png&amp;s=66582" alt></p>
<h3 id="第一步：设置数据源属性"><a class="header-anchor" href="#第一步：设置数据源属性">¶</a>第一步：设置数据源属性</h3>
<p>在初始化<code>DataSource</code>之前，我们需要将各属性设置进去，这里使用<code>HoneycombWrapperDatasource</code>中的<code>HoneycombDatasourceConfig</code>来承载各属性：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HoneycombDatasourceConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//db url</span></span><br><span class="line">    <span class="keyword">private</span> String url;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//db user</span></span><br><span class="line">    <span class="keyword">private</span> String user;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//db password</span></span><br><span class="line">    <span class="keyword">private</span> String password;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//driver驱动</span></span><br><span class="line">    <span class="keyword">private</span> String driver;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//初始化连接数，默认为2</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> initialPoolSize = <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//最大连接数，默认为10</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> maxPoolSize = <span class="number">10</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//最小连接数，默认为2</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> minPoolSize = <span class="number">2</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//获取连接时，最大等待时长，默认为60s</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">long</span> maxWaitTime = <span class="number">60</span> * <span class="number">1000</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//最大空闲时长，超出要被回收，默认为20s</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">long</span> maxIdleTime = <span class="number">20</span> * <span class="number">1000</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//特性列表</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;AbstractFeature&gt; features;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">HoneycombDatasourceConfig</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        features = <span class="keyword">new</span> ArrayList&lt;AbstractFeature&gt;(<span class="number">5</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    省略getter、setter....</span><br></pre></td></tr></table></figure>
<h3 id="第二步：初始化连接池"><a class="header-anchor" href="#第二步：初始化连接池">¶</a>第二步：初始化连接池</h3>
<p>设置好属性之后，我们需要完成连接池的初始化工作，在<code>HoneycombDataSource</code>的<code>init</code>方法中实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> <span class="keyword">throws</span> ClassNotFoundException, SQLException </span>&#123;</span><br><span class="line">    <span class="comment">//阻塞其他线程初始化操作，等待初始化完成</span></span><br><span class="line">    <span class="keyword">if</span>(initialStarted || ! (initialStarted = ! initialStarted)) &#123;</span><br><span class="line">        <span class="keyword">if</span>(! initialFinished) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                INITIAL_LOCK.lock();</span><br><span class="line">                INITIAL_CONDITION.await();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                INITIAL_LOCK.unlock();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//config参数校验</span></span><br><span class="line">    config.assertSelf();</span><br><span class="line">    </span><br><span class="line">    Class.forName(getDriver());</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//实例化线程池</span></span><br><span class="line">    pool = <span class="keyword">new</span> HoneycombConnectionPool(config);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//初始化最小连接</span></span><br><span class="line">    Integer index = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; config.getInitialPoolSize(); i ++) &#123;</span><br><span class="line">        <span class="keyword">if</span>((index =  pool.applyIndex()) != <span class="keyword">null</span>) &#123;</span><br><span class="line">            pool.putLeisureConnection(createNativeConnection(pool), index);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//触发特性</span></span><br><span class="line">    pool.touchFeatures();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//完成初始化并唤醒其他阻塞</span></span><br><span class="line">    initialFinished = <span class="keyword">true</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        INITIAL_LOCK.lock();</span><br><span class="line">        INITIAL_CONDITION.signalAll();</span><br><span class="line">    &#125;<span class="keyword">catch</span>(Exception e) &#123;</span><br><span class="line">    &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">        INITIAL_LOCK.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="第三步：创建初始连接"><a class="header-anchor" href="#第三步：创建初始连接">¶</a>第三步：创建初始连接</h3>
<p>在<code>init</code>的方法中，如果<code>initialPoolSize</code>大于0，会去创建指定数量的物理连接放入连接池中，创建数量要小于最大连接数<code>maxPoolSize</code>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> HoneycombConnection <span class="title">createNativeConnection</span><span class="params">(HoneycombConnectionPool pool)</span> <span class="keyword">throws</span> SQLException </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> HoneycombConnection(<span class="keyword">super</span>.getConnection(), pool);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>完成初始化后，下一步就是获取连接。</p>
<h3 id="第四步：从空闲池获取"><a class="header-anchor" href="#第四步：从空闲池获取">¶</a>第四步：从空闲池获取</h3>
<p>我们之前将连接池分成了三个，它们分别是<strong>空闲池</strong>、<strong>工作池</strong>和<strong>回收池</strong>。</p>
<p>我们可以通过<code>HoneycombDataSource</code>的<code>getConnection</code>方法来获取连接，当我们需要获取时，首先考虑的是空闲池是否有空闲连接，这样可以避免创建和激活新的连接：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Connection <span class="title">getConnection</span><span class="params">()</span> <span class="keyword">throws</span> SQLException </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">    	<span class="comment">//初始化连接池</span></span><br><span class="line">        init();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(e);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    HoneycombConnection cn = <span class="keyword">null</span>;</span><br><span class="line">    Integer index = <span class="keyword">null</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span>(pool.assignable()) &#123;</span><br><span class="line">    	<span class="comment">//空闲池可分配，从空闲池取出</span></span><br><span class="line">        cn = pool.getIdleConnection();</span><br><span class="line">    &#125;<span class="keyword">else</span> <span class="keyword">if</span>(pool.actionable()) &#123;</span><br><span class="line">    	<span class="comment">//回收池可分配，从回收池取出</span></span><br><span class="line">        cn = pool.getFreezeConnection();</span><br><span class="line">    &#125;<span class="keyword">else</span> <span class="keyword">if</span>((index =  pool.applyIndex()) != <span class="keyword">null</span>) &#123;</span><br><span class="line">    	<span class="comment">//如果连接数未满，创建新的物理连接</span></span><br><span class="line">        cn = pool.putOccupiedConnection(createNativeConnection(pool), index);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span>(cn == <span class="keyword">null</span>) &#123;</span><br><span class="line">    	<span class="comment">//如果无法获取连接，阻塞等待空闲池连接</span></span><br><span class="line">        cn = pool.getIdleConnection();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span>(cn.isClosedActive()) &#123;</span><br><span class="line">    	<span class="comment">//如果物理连接关闭，则获取新的连接</span></span><br><span class="line">        cn.setConnection(<span class="keyword">super</span>.getConnection());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> cn;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="第五步：从回收池获取"><a class="header-anchor" href="#第五步：从回收池获取">¶</a>第五步：从回收池获取</h3>
<p>如果空闲池不可分配，那么说明连接供不应求，也许之前有些空闲连接已经被回收（物理关闭），那么我们在创建新连接之前，可以到回收池看一下是否存在已回收连接，如果存在直接取出：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">else</span> <span class="keyword">if</span>(pool.actionable()) &#123;</span><br><span class="line">	<span class="comment">//回收池可分配，从回收池取出</span></span><br><span class="line">    cn = pool.getFreezeConnection();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="第六步：创建新的连接"><a class="header-anchor" href="#第六步：创建新的连接">¶</a>第六步：创建新的连接</h3>
<p>如果回收池也不可分配，此时要判断连接池连接数量是否已经达到最大连接，如果没有达到，创建新的物理连接并直接添加到工作池中：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">else</span> <span class="keyword">if</span>((index =  pool.applyIndex()) != <span class="keyword">null</span>) &#123;</span><br><span class="line">	<span class="comment">//如果连接数未满，创建新的物理连接，添加到工作池</span></span><br><span class="line">    cn = pool.putOccupiedConnection(createNativeConnection(pool), index);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="第七步：等待空闲池的连接"><a class="header-anchor" href="#第七步：等待空闲池的连接">¶</a>第七步：等待空闲池的连接</h3>
<p>如果上述三种情况都不满足，那么只能从空闲池等待其他连接的释放：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(cn == <span class="keyword">null</span>) &#123;</span><br><span class="line">	<span class="comment">//如果无法获取连接，阻塞等待空闲池连接</span></span><br><span class="line">    cn = pool.getIdleConnection();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>具体逻辑封装在<code>HoneycombConnectionPool</code>的<code>getIdleConnection</code>方法中：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> HoneycombConnection <span class="title">getIdleConnection</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">    	<span class="comment">//获取最大等待时间</span></span><br><span class="line">        <span class="keyword">long</span> waitTime = config.getMaxWaitTime();</span><br><span class="line">        <span class="keyword">while</span>(waitTime &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">long</span> beginPollNanoTime = System.nanoTime();</span><br><span class="line">            </span><br><span class="line">            <span class="comment">//设置超时时间，阻塞等待其他连接的释放</span></span><br><span class="line">            HoneycombConnection nc = idleQueue.poll(waitTime, TimeUnit.MILLISECONDS);</span><br><span class="line">            <span class="keyword">if</span>(nc != <span class="keyword">null</span>) &#123;</span><br><span class="line">            	<span class="comment">//状态转换</span></span><br><span class="line">                <span class="keyword">if</span>(nc.isClosed() &amp;&amp; nc.switchOccupied() &amp;&amp; working(nc)) &#123;</span><br><span class="line">                    <span class="keyword">return</span> nc;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">long</span> timeConsuming = (System.nanoTime() - beginPollNanoTime) / (<span class="number">1000</span> * <span class="number">1000</span>);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">//也许在超时时间内获取到了连接，但是状态转换失败，此时刷新超时时间</span></span><br><span class="line">            waitTime -= timeConsuming;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"获取连接超时"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="第八步：激活连接"><a class="header-anchor" href="#第八步：激活连接">¶</a>第八步：激活连接</h3>
<p>最后，判断一下连接是否被物理关闭，如果是，我们需要打开新的连接替换已经被回收的连接：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(cn.isClosedActive()) &#123;</span><br><span class="line">	<span class="comment">//如果物理连接关闭，则获取新的连接</span></span><br><span class="line">    cn.setConnection(<span class="keyword">super</span>.getConnection());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="连接的回收"><a class="header-anchor" href="#连接的回收">¶</a>连接的回收</h3>
<p>如果在某段时间内我们的业务量剧增，那么需要同时工作的连接将会很多，之后过了不久，我们的业务量下降，那么之前已经创建的连接明显饱和，这时就需要我们对其进行回收，我们可以通过<code>AbstractFeature</code>入口操作连接池。</p>
<p>对于回收这个操作，我们通过<code>CleanerFeature</code>来实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CleanerFeature</span> <span class="keyword">extends</span> <span class="title">AbstractFeature</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Logger logger = LoggerFactory.getLogger(CleanerFeature<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">CleanerFeature</span><span class="params">(<span class="keyword">boolean</span> enable, <span class="keyword">long</span> interval)</span> </span>&#123;</span><br><span class="line">       <span class="comment">//enable表示是否启用</span></span><br><span class="line">       <span class="comment">//interval表示扫描间隔</span></span><br><span class="line">       <span class="keyword">super</span>(enable, interval);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doing</span><span class="params">(HoneycombConnectionPool pool)</span> </span>&#123;</span><br><span class="line">        LinkedBlockingDeque&lt;HoneycombConnection&gt; idleQueue = pool.getIdleQueue();</span><br><span class="line">        Thread t = <span class="keyword">new</span> Thread() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                <span class="keyword">while</span>(<span class="keyword">true</span>) &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        <span class="comment">//回收扫描间隔</span></span><br><span class="line">                    	Thread.sleep(interval);</span><br><span class="line">                        </span><br><span class="line">                    	<span class="comment">//回收时，空闲池上锁</span></span><br><span class="line">                        <span class="keyword">synchronized</span> (idleQueue) &#123;</span><br><span class="line">                            logger.debug(<span class="string">"Cleaner Model To Start &#123;&#125;"</span>, idleQueue.size());</span><br><span class="line">                            <span class="comment">//回收操作</span></span><br><span class="line">                            idleQueue.stream().filter(c -&gt; &#123; <span class="keyword">return</span> c.idleTime() &gt; pool.getConfig().getMaxIdleTime(); &#125;).forEach(c -&gt; &#123;</span><br><span class="line">                                <span class="keyword">try</span> &#123;</span><br><span class="line">                                    <span class="keyword">if</span>(! c.isClosedActive() &amp;&amp; c.idle()) &#123;</span><br><span class="line">                                        c.closeActive();</span><br><span class="line">                                        pool.freeze(c);</span><br><span class="line">                                    &#125;</span><br><span class="line">                                &#125; <span class="keyword">catch</span> (SQLException e) &#123;</span><br><span class="line">                                    e.printStackTrace();</span><br><span class="line">                                &#125; </span><br><span class="line">                            &#125;);</span><br><span class="line">                            logger.debug(<span class="string">"Cleaner Model To Finished &#123;&#125;"</span>, idleQueue.size());</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;<span class="keyword">catch</span>(Throwable e) &#123;</span><br><span class="line">                        logger.error(<span class="string">"Cleaner happended error"</span>, e);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        t.setDaemon(<span class="keyword">true</span>);</span><br><span class="line">        t.start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里的操作很简单，对空闲池加锁，扫描所有连接，释放空闲时间超过最大空闲时间设置的连接，其实这里只要知道当前连接的空闲时长就一目了然了，我们在连接放入空闲池时候去刷新他的空闲时间点，那么当前的空闲时长就等于当前时间减去空闲开始时间：</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">idleTime = nowTime - idleStartTime</span><br></pre></td></tr></table></figure>
<p>在切换状态为空闲时刷新空闲开始时间：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"> <span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">switchIdle</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> unsafe.compareAndSwapObject(<span class="keyword">this</span>, statusOffset, status, ConnectionStatus.IDLE) &amp;&amp; flushIdleStartTime();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="测试一下"><a class="header-anchor" href="#测试一下">¶</a>测试一下</h2>
<p>体验成果的最快途径就是投入使用，这里搞一个单元测试体验一下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> ThreadPoolExecutor tpe = <span class="keyword">new</span> ThreadPoolExecutor(<span class="number">1000</span>, <span class="number">1000</span>, <span class="number">0</span>, TimeUnit.MILLISECONDS, <span class="keyword">new</span> LinkedBlockingQueue&lt;Runnable&gt;());</span><br><span class="line">    </span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testConcurrence</span><span class="params">()</span> <span class="keyword">throws</span> SQLException, InterruptedException</span>&#123;</span><br><span class="line">    <span class="keyword">long</span> start = System.currentTimeMillis();</span><br><span class="line">    HoneycombDataSource dataSource = <span class="keyword">new</span> HoneycombDataSource();</span><br><span class="line">    dataSource.setUrl(<span class="string">"jdbc:mysql://localhost:3306/test?useUnicode=true&amp;characterEncoding=UTF-8&amp;useSSL=false&amp;transformedBitIsBoolean=true&amp;zeroDateTimeBehavior=CONVERT_TO_NULL&amp;serverTimezone=Asia/Shanghai"</span>);</span><br><span class="line">    dataSource.setUser(<span class="string">"root"</span>);</span><br><span class="line">    dataSource.setPassword(<span class="string">"root"</span>);</span><br><span class="line">    dataSource.setDriver(<span class="string">"com.mysql.cj.jdbc.Driver"</span>);</span><br><span class="line">    dataSource.setMaxPoolSize(<span class="number">50</span>);</span><br><span class="line">    dataSource.setInitialPoolSize(<span class="number">10</span>);</span><br><span class="line">    dataSource.setMinPoolSize(<span class="number">10</span>);</span><br><span class="line">    dataSource.setMaxWaitTime(<span class="number">60</span> * <span class="number">1000</span>);</span><br><span class="line">    dataSource.setMaxIdleTime(<span class="number">10</span> * <span class="number">1000</span>);</span><br><span class="line">    dataSource.addFeature(<span class="keyword">new</span> CleanerFeature(<span class="keyword">true</span>, <span class="number">5</span> * <span class="number">1000</span>));</span><br><span class="line">    </span><br><span class="line">    test(dataSource, <span class="number">10000</span>);</span><br><span class="line">    System.out.println(System.currentTimeMillis() - start + <span class="string">" ms"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">test</span><span class="params">(DataSource dataSource, <span class="keyword">int</span> count)</span> <span class="keyword">throws</span> SQLException, InterruptedException </span>&#123;</span><br><span class="line">    CountDownLatch cdl = <span class="keyword">new</span> CountDownLatch(count);</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; count; i ++) &#123;</span><br><span class="line">        tpe.execute(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                HoneycombConnection connection = (HoneycombConnection) dataSource.getConnection();</span><br><span class="line">                Statement s = connection.createStatement();</span><br><span class="line">                s.executeQuery(<span class="string">"select * from test limit 1"</span>);</span><br><span class="line">                connection.close();</span><br><span class="line">            &#125;<span class="keyword">catch</span>(Exception e) &#123;</span><br><span class="line">            &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">                cdl.countDown();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    cdl.await();</span><br><span class="line">    tpe.shutdown();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>PC配置：<strong>Intel® Core™ i5-8300H CPU @ 2.30GHz 2.30 GHz 4核8G 512SSD</strong></p>
<p>10000次查询，耗时：</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">938</span> ms</span><br></pre></td></tr></table></figure>
<p>结束语：再次召唤传送门：<a href="https://github.com/ainilili/honeycomb" target="_blank" rel="noopener">https://github.com/ainilili/honeycomb</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/12/25/深入JAVA8的HashMap实现原理/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Nico">
      <meta itemprop="description" content>
      <meta itemprop="image" content="https://avatars1.githubusercontent.com/u/26395860?s=460&v=4">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Nico's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/12/25/深入JAVA8的HashMap实现原理/" itemprop="url">深入JAVA8的HashMap实现原理</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-12-25T19:42:00+08:00">
                2018-12-25
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/数据结构/" itemprop="url" rel="index">
                    <span itemprop="name">数据结构</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="引导"><a class="header-anchor" href="#引导">¶</a>引导</h2>
<p>在了解<code>HashMap</code>之前，我们应该先明白两个概念：<code>Hash</code>和<code>Map</code>，这可以帮助我们更容易了解<code>HashMap</code>的运行原理。</p>
<p>那么何为<code>Hash</code>，又何为<code>Map</code>呢？</p>
<h3 id="hash"><a class="header-anchor" href="#hash">¶</a>Hash</h3>
<p>之前写过一篇关于Hash的文章 <a href="/zh-cn/java/data-structure/hash.md">Hash</a></p>
<h3 id="map"><a class="header-anchor" href="#map">¶</a>Map</h3>
<p>Map是一种<code>K-V</code>形式的数据结构，一个唯一的key，会唯一对应一个value。也就是说，在Map容器里不允许两个一模一样的key。</p>
<p>一个简单的Map结构如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;key1&quot;:&quot;value1&quot;,</span><br><span class="line">  &quot;key2&quot;:&quot;value2&quot;,</span><br><span class="line">  &quot;key3&quot;:&quot;value3&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>对于这种数据结构，并且Map会对外提供一些方法来实现对内部数据的操作：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">V put(K key, V value)</span><br><span class="line">V get(Object key)</span><br><span class="line">V remove(Object key)</span><br><span class="line">boolean containsKey(Object key)</span><br></pre></td></tr></table></figure>
<p>可见Map对于我们操作<code>K-V</code>形式的数据非常方便，实现的方式有很多，最简单粗暴的实现方式是使用<code>List</code>来存储每一个<code>K-V</code>组对，对于每种方法的实现只需要暴力循环碰撞即可，对于少量数据这种做法未必不可，如果数据量庞大之千万，我们就要换一种更加高效，速度更快的实现方式：<code>HashMap</code>。</p>
<h2 id="hashmap"><a class="header-anchor" href="#hashmap">¶</a>HashMap</h2>
<p>Map在Java中的实现有很多，<code>HashMap</code>便是其中之一，在<code>JDK</code>漫长的版本更新中，<code>HashMap</code>的实现也是在不断的更新着：</p>
<ul>
<li><strong>&lt;=JDK1.7</strong>：Table数组 + Entry链表</li>
<li><strong>&gt;=JDK1.8</strong>：Table数组 + Entry链表/红黑树</li>
</ul>
<p>本文我们跳过JDK1.7的实现，来看一下1.8中<code>HashMap</code>源码所带来的魅力冲击！</p>
<h3 id="实现原理"><a class="header-anchor" href="#实现原理">¶</a>实现原理</h3>
<p>对于各个版本的<code>HashMap</code>实现原理，主线流程都是一成不变的：</p>
<p><img src="https://github.com/ainilili/snail/blob/master/docs/images/hashmap-1.8-1-1.jpg?raw=true" alt="hashmap原理流程图"></p>
<p>这里有两个数据结构需要我们知道：</p>
<ul>
<li><strong>Table</strong>：哈希表，存放Node元素。</li>
<li><strong>Node</strong>：结点元素，存放<code>K-V</code>组对信息，其结构是一个链表/红黑树。</li>
</ul>
<p>另外，在HashMap内部有一些关键属性我们也要了解一下：</p>
<ul>
<li><strong>DEFAULT_INITIAL_CAPACITY</strong>：Table数组初始长度，默认为<code>1 &lt;&lt; 4</code>，<code>2^4</code> = 16。</li>
<li><strong>MAXIMUM_CAPACITY</strong>：Table数组最高长度，默认为<code>1 &lt;&lt; 30</code>，<code>2^30</code> = 1073741824。</li>
<li><strong>DEFAULT_LOAD_FACTOR</strong>：负载因子，当总元素数 &gt; 数组长度 * 负载因子时，Table数组将会扩容，默认为0.75。</li>
<li><strong>TREEIFY_THRESHOLD</strong>：树化阈值，当单个Table内Node数量超过该值，则会将链表转化为红黑树，默认为8。</li>
<li><strong>UNTREEIFY_THRESHOLD</strong>：链化阈值，当扩容期间单个Table内Entry数量小于该值，则将红黑树转化为链表，默认为6。</li>
<li><strong>MIN_TREEIFY_CAPACITY</strong>：最小树化阈值，当Table所有元素超过改值，才会进行树化（为了防止前期阶段频繁扩容和树化过程冲突）。</li>
<li><strong>size</strong>：Table数组当前所有元素数。</li>
<li><strong>threshold</strong>：下次扩容的阈值（数组长度 * 负载因子）</li>
</ul>
<p>HashMap的内部有着一个Table数组，而这个数组的初始长度为<code>DEFAULT_INITIAL_CAPACITY</code>参数值，Table数组存放的元素类型就是Node，它是一个单向链表：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Node</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt; <span class="keyword">implements</span> <span class="title">Map</span>.<span class="title">Entry</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt; </span>&#123;</span><br><span class="line">  <span class="keyword">final</span> <span class="keyword">int</span> hash; <span class="comment">//key的hash值</span></span><br><span class="line">  <span class="keyword">final</span> K key;  <span class="comment">//key</span></span><br><span class="line">  V value;  <span class="comment">//value</span></span><br><span class="line">  Node&lt;K,V&gt; next; <span class="comment">//下一个结点</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>每个Table中存的Node元素相当于链表的<code>header</code>，<code>next</code>指向下一个结点，而这种链式结构的存在正是为了解决<code>hash冲突</code>：</p>
<blockquote>
<p><strong>hash冲突</strong>：两个元素的经过Hash散列之后分在同一个组内，我们将之解释为Hash冲突</p>
</blockquote>
<p>在JDK1.7之前的版本，hash冲突的解决方法是将被冲突的Node结点放于一个链表中，而Table中的元素则是链头，当然在JDK1.8中，当Table中链长超过<code>TREEIFY_THRESHOLD</code>阈值后，将会将链表转变为红黑树的实现<code>TreeNode</code>：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">static final class TreeNode&lt;K,V&gt; extends LinkedHashMap.Entry&lt;K,V&gt; &#123;</span><br><span class="line">  TreeNode&lt;K,V&gt; parent;  // red-black tree links</span><br><span class="line">  TreeNode&lt;K,V&gt; left;</span><br><span class="line">  TreeNode&lt;K,V&gt; right;</span><br><span class="line">  TreeNode&lt;K,V&gt; prev;    // needed to unlink next upon deletion</span><br><span class="line">  boolean red;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>当发生hash冲突的Node不断变多，那么这个链将会越来越长，那么遍历碰撞key时的耗时就会不断增加，这也就直接导致了性能的不足，从JDK1.8开始，HashMap对于单个Table中的Node超出某个阈值时，将会开始树化操作（链表转化为红黑树），这对于搜索的性能将会有很大的提升，而插入和删除的操作所带来的性能影响微乎其微。</p>
<h3 id="put方法"><a class="header-anchor" href="#put方法">¶</a>put方法</h3>
<p>在<code>HashMap</code>的内部会有一个Table数组，这个数组的当前长度就是我们要实现映射的目标范围，当我们执行<code>put</code>方法时，<code>key</code>和<code>value</code>要经历这些事情：</p>
<ul>
<li>通过<code>Hash</code>散列获取到对应的Table</li>
<li>遍历Table下的Node结点，做更新/添加操作</li>
<li>扩容检测</li>
</ul>
<p>具体实现我们可以根据源码来详细了解一下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> V <span class="title">putVal</span><span class="params">(<span class="keyword">int</span> hash, K key, V value, <span class="keyword">boolean</span> onlyIfAbsent,</span></span></span><br><span class="line"><span class="function"><span class="params">                   <span class="keyword">boolean</span> evict)</span> </span>&#123;</span><br><span class="line">    Node&lt;K,V&gt;[] tab; Node&lt;K,V&gt; p; <span class="keyword">int</span> n, i;</span><br><span class="line">    <span class="keyword">if</span> ((tab = table) == <span class="keyword">null</span> || (n = tab.length) == <span class="number">0</span>)</span><br><span class="line">        <span class="comment">// HashMap的懒加载策略，当执行put操作时检测Table数组初始化。</span></span><br><span class="line">        n = (tab = resize()).length;</span><br><span class="line">    <span class="keyword">if</span> ((p = tab[i = (n - <span class="number">1</span>) &amp; hash]) == <span class="keyword">null</span>)</span><br><span class="line">        <span class="comment">//通过``Hash``函数获取到对应的Table，如果当前Table为空，则直接初始化一个新的Node并放入该Table中。</span></span><br><span class="line">        tab[i] = newNode(hash, key, value, <span class="keyword">null</span>);</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        Node&lt;K,V&gt; e; K k;</span><br><span class="line">        <span class="keyword">if</span> (p.hash == hash &amp;&amp;</span><br><span class="line">            ((k = p.key) == key || (key != <span class="keyword">null</span> &amp;&amp; key.equals(k))))</span><br><span class="line">            <span class="comment">//输入的key命中了当前Table的首元素，直接更新。</span></span><br><span class="line">            e = p;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (p <span class="keyword">instanceof</span> TreeNode)</span><br><span class="line">            <span class="comment">//如果当前Node类型为TreeNode，调用``putTreeVal``方法。</span></span><br><span class="line">            e = ((TreeNode&lt;K,V&gt;)p).putTreeVal(<span class="keyword">this</span>, tab, hash, key, value);</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">//如果不是TreeNode，则就是链表，遍历并与输入key做命中碰撞。</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> binCount = <span class="number">0</span>; ; ++binCount) &#123;</span><br><span class="line">                <span class="keyword">if</span> ((e = p.next) == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="comment">//如果当前Table中不存在当前key，则添加。</span></span><br><span class="line">                    p.next = newNode(hash, key, value, <span class="keyword">null</span>);</span><br><span class="line">                    <span class="keyword">if</span> (binCount &gt;= TREEIFY_THRESHOLD - <span class="number">1</span>) <span class="comment">// -1 for 1st</span></span><br><span class="line">                        <span class="comment">//超过了``TREEIFY_THRESHOLD``则转化为红黑树。</span></span><br><span class="line">                        treeifyBin(tab, hash);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (e.hash == hash &amp;&amp;</span><br><span class="line">                    ((k = e.key) == key || (key != <span class="keyword">null</span> &amp;&amp; key.equals(k))))</span><br><span class="line">                    <span class="comment">//做命中碰撞，使用hash、内存和equals同时判断（不同的元素hash可能会一致）。</span></span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                p = e;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (e != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">//如果命中不为空，更新操作。</span></span><br><span class="line">            V oldValue = e.value;</span><br><span class="line">            <span class="keyword">if</span> (!onlyIfAbsent || oldValue == <span class="keyword">null</span>)</span><br><span class="line">                e.value = value;</span><br><span class="line">            afterNodeAccess(e);</span><br><span class="line">            <span class="keyword">return</span> oldValue;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    ++modCount;</span><br><span class="line">    <span class="keyword">if</span> (++size &gt; threshold)</span><br><span class="line">        <span class="comment">//扩容检测。</span></span><br><span class="line">        resize();</span><br><span class="line">    afterNodeInsertion(evict);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>对于其过程中的关于Node链表和红黑树的转换过程我们可以暂时屏蔽掉，那么整个流程并不是很绕，那么我们继续深入的来看一下HashMap的扩容实现。</p>
<h3 id="resize方法"><a class="header-anchor" href="#resize方法">¶</a>resize方法</h3>
<p>HashMap的扩容大致的实现是将老Table数组中所有的Entry取出来，重新对其hashcode做<code>Hash</code>散列到新的新的Table之中，也就是一个<code>re-put</code>的过程，具体还是通过源码来讲解：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> Node&lt;K,V&gt;[] resize() &#123;</span><br><span class="line">    <span class="comment">//保留老的hash表</span></span><br><span class="line">    Node&lt;K,V&gt;[] oldTab = table;</span><br><span class="line">    <span class="keyword">int</span> oldCap = (oldTab == <span class="keyword">null</span>) ? <span class="number">0</span> : oldTab.length;</span><br><span class="line">    <span class="keyword">int</span> oldThr = threshold;</span><br><span class="line">    <span class="keyword">int</span> newCap, newThr = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">//如果之前的容量大于0</span></span><br><span class="line">    <span class="keyword">if</span> (oldCap &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">//如果超出最大容量</span></span><br><span class="line">        <span class="keyword">if</span> (oldCap &gt;= MAXIMUM_CAPACITY) &#123;</span><br><span class="line">            <span class="comment">//扩容阈值为int最大值</span></span><br><span class="line">            threshold = Integer.MAX_VALUE;</span><br><span class="line">            <span class="keyword">return</span> oldTab;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//否则计算扩容后的阈值</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> ((newCap = oldCap &lt;&lt; <span class="number">1</span>) &lt; MAXIMUM_CAPACITY &amp;&amp;</span><br><span class="line">                 oldCap &gt;= DEFAULT_INITIAL_CAPACITY)</span><br><span class="line">            newThr = oldThr &lt;&lt; <span class="number">1</span>; <span class="comment">// double threshold</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (oldThr &gt; <span class="number">0</span>)</span><br><span class="line">        <span class="comment">// 如果之前的容量等于0，并且之前的阈值大于零，则新的hash表长度就等于它</span></span><br><span class="line">        newCap = oldThr;</span><br><span class="line">    <span class="keyword">else</span> &#123;              </span><br><span class="line">        <span class="comment">// 初始阈值为零表示使用默认值</span></span><br><span class="line">        newCap = DEFAULT_INITIAL_CAPACITY;</span><br><span class="line">        newThr = (<span class="keyword">int</span>)(DEFAULT_LOAD_FACTOR * DEFAULT_INITIAL_CAPACITY);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//如果新的阈值为 0 ，就得用 新容量*加载因子 重计算一次</span></span><br><span class="line">    <span class="keyword">if</span> (newThr == <span class="number">0</span>) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">float</span> ft = (<span class="keyword">float</span>)newCap * loadFactor;</span><br><span class="line">        newThr = (newCap &lt; MAXIMUM_CAPACITY &amp;&amp; ft &lt; (<span class="keyword">float</span>)MAXIMUM_CAPACITY ?</span><br><span class="line">                  (<span class="keyword">int</span>)ft : Integer.MAX_VALUE);</span><br><span class="line">    &#125;</span><br><span class="line">    threshold = newThr;</span><br><span class="line">    <span class="comment">//常见扩容后的hash表</span></span><br><span class="line">    <span class="meta">@SuppressWarnings</span>(&#123;<span class="string">"rawtypes"</span>,<span class="string">"unchecked"</span>&#125;)</span><br><span class="line">        Node&lt;K,V&gt;[] newTab = (Node&lt;K,V&gt;[])<span class="keyword">new</span> Node[newCap];</span><br><span class="line">    table = newTab; <span class="comment">//A</span></span><br><span class="line">    <span class="keyword">if</span> (oldTab != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">//遍历旧的hash表，将之内部元素转移到新的hash表</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; oldCap; ++j) &#123;</span><br><span class="line">            Node&lt;K,V&gt; e;</span><br><span class="line">            <span class="keyword">if</span> ((e = oldTab[j]) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                oldTab[j] = <span class="keyword">null</span>;</span><br><span class="line">                <span class="keyword">if</span> (e.next == <span class="keyword">null</span>)</span><br><span class="line">                    <span class="comment">//如果当前Table内只有一个元素，重新做hash散列并赋值</span></span><br><span class="line">                    newTab[e.hash &amp; (newCap - <span class="number">1</span>)] = e; <span class="comment">//B</span></span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (e <span class="keyword">instanceof</span> TreeNode)</span><br><span class="line">                    <span class="comment">//如果旧哈希表中这个位置的桶是树形结构，就要把新哈希表里当前桶也变成树形结构</span></span><br><span class="line">                    ((TreeNode&lt;K,V&gt;)e).split(<span class="keyword">this</span>, newTab, j, oldCap);</span><br><span class="line">                <span class="keyword">else</span> &#123; <span class="comment">//保留旧哈希表桶中链表的顺序</span></span><br><span class="line">                    Node&lt;K,V&gt; loHead = <span class="keyword">null</span>, loTail = <span class="keyword">null</span>;</span><br><span class="line">                    Node&lt;K,V&gt; hiHead = <span class="keyword">null</span>, hiTail = <span class="keyword">null</span>;</span><br><span class="line">                    Node&lt;K,V&gt; next;</span><br><span class="line">                    <span class="keyword">do</span> &#123;  <span class="comment">//遍历当前Table内的Node，赋值给新的Table</span></span><br><span class="line">                        next = e.next;</span><br><span class="line">                        <span class="keyword">if</span> ((e.hash &amp; oldCap) == <span class="number">0</span>) &#123;</span><br><span class="line">                            <span class="keyword">if</span> (loTail == <span class="keyword">null</span>)</span><br><span class="line">                                loHead = e;</span><br><span class="line">                            <span class="keyword">else</span></span><br><span class="line">                                loTail.next = e;</span><br><span class="line">                            loTail = e;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">else</span> &#123;</span><br><span class="line">                            <span class="keyword">if</span> (hiTail == <span class="keyword">null</span>)</span><br><span class="line">                                hiHead = e;</span><br><span class="line">                            <span class="keyword">else</span></span><br><span class="line">                                hiTail.next = e;</span><br><span class="line">                            hiTail = e;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; <span class="keyword">while</span> ((e = next) != <span class="keyword">null</span>);</span><br><span class="line">                    <span class="keyword">if</span> (loTail != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        loTail.next = <span class="keyword">null</span>;</span><br><span class="line">                        newTab[j] = loHead;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span> (hiTail != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        hiTail.next = <span class="keyword">null</span>;</span><br><span class="line">                        newTab[j + oldCap] = hiHead;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> newTab;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="get方法"><a class="header-anchor" href="#get方法">¶</a>get方法</h3>
<p>在我们看完HashMap对于put方法的实现之后，get方法则显得简单易懂，其代码与put相近无几，主要差别是没有了扩容和添加/更新的操作：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> Node&lt;K,V&gt; <span class="title">getNode</span><span class="params">(<span class="keyword">int</span> hash, Object key)</span> </span>&#123;</span><br><span class="line">    Node&lt;K,V&gt;[] tab; Node&lt;K,V&gt; first, e; <span class="keyword">int</span> n; K k;</span><br><span class="line">    <span class="comment">//判断hash表是否为空，表重读是否大于零并且当前key对应分布的表内是否有Node存在</span></span><br><span class="line">    <span class="keyword">if</span> ((tab = table) != <span class="keyword">null</span> &amp;&amp; (n = tab.length) &gt; <span class="number">0</span> &amp;&amp;</span><br><span class="line">        (first = tab[(n - <span class="number">1</span>) &amp; hash]) != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (first.hash == hash &amp;&amp;</span><br><span class="line">            ((k = first.key) == key || (key != <span class="keyword">null</span> &amp;&amp; key.equals(k))))</span><br><span class="line">            <span class="comment">// 检测第一个Node，命中则不需要在做do...while...循环</span></span><br><span class="line">            <span class="keyword">return</span> first;</span><br><span class="line">        <span class="keyword">if</span> ((e = first.next) != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (first <span class="keyword">instanceof</span> TreeNode)</span><br><span class="line">                <span class="comment">//如果Table内是树形结构，则使用对应的检索方法</span></span><br><span class="line">                <span class="keyword">return</span> ((TreeNode&lt;K,V&gt;)first).getTreeNode(hash, key);</span><br><span class="line">            <span class="keyword">do</span> &#123; <span class="comment">//如果是链表，则做while循环，直到命中或者遍历结束</span></span><br><span class="line">                <span class="keyword">if</span> (e.hash == hash &amp;&amp;</span><br><span class="line">                    ((k = e.key) == key || (key != <span class="keyword">null</span> &amp;&amp; key.equals(k))))</span><br><span class="line">                    <span class="keyword">return</span> e;</span><br><span class="line">            &#125; <span class="keyword">while</span> ((e = e.next) != <span class="keyword">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="containskey方法"><a class="header-anchor" href="#containskey方法">¶</a>containsKey方法</h3>
<p>根据get方法的结果是否为空就可以直到是否包含该key：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public boolean containsKey(Object key) &#123;</span><br><span class="line">    return getNode(hash(key), key) != null;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="remove方法"><a class="header-anchor" href="#remove方法">¶</a>remove方法</h3>
<p>同样类似于put操作，首先会查找对应的key所在位置，如果为空，则不操作，反之，将之移除：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> Node&lt;K,V&gt; <span class="title">removeNode</span><span class="params">(<span class="keyword">int</span> hash, Object key, Object value,</span></span></span><br><span class="line"><span class="function"><span class="params">                               <span class="keyword">boolean</span> matchValue, <span class="keyword">boolean</span> movable)</span> </span>&#123;</span><br><span class="line">    Node&lt;K,V&gt;[] tab; Node&lt;K,V&gt; p; <span class="keyword">int</span> n, index;</span><br><span class="line">    <span class="comment">//判断hash表是否为空，表重读是否大于零并且当前key对应分布的表内是否有Node存在</span></span><br><span class="line">    <span class="keyword">if</span> ((tab = table) != <span class="keyword">null</span> &amp;&amp; (n = tab.length) &gt; <span class="number">0</span> &amp;&amp;</span><br><span class="line">        (p = tab[index = (n - <span class="number">1</span>) &amp; hash]) != <span class="keyword">null</span>) &#123;</span><br><span class="line">        Node&lt;K,V&gt; node = <span class="keyword">null</span>, e; K k; V v;</span><br><span class="line">        <span class="keyword">if</span> (p.hash == hash &amp;&amp;</span><br><span class="line">            ((k = p.key) == key || (key != <span class="keyword">null</span> &amp;&amp; key.equals(k))))</span><br><span class="line">            <span class="comment">// 第一个Node命中</span></span><br><span class="line">            node = p;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> ((e = p.next) != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (p <span class="keyword">instanceof</span> TreeNode)</span><br><span class="line">                <span class="comment">//如果Table内是树形结构，则使用对应的检索方法</span></span><br><span class="line">                node = ((TreeNode&lt;K,V&gt;)p).getTreeNode(hash, key);</span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">do</span> &#123; <span class="comment">//如果是链表，则做while循环，直到命中或者遍历结束</span></span><br><span class="line">                    <span class="keyword">if</span> (e.hash == hash &amp;&amp;</span><br><span class="line">                        ((k = e.key) == key ||</span><br><span class="line">                         (key != <span class="keyword">null</span> &amp;&amp; key.equals(k)))) &#123;</span><br><span class="line">                        node = e;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    p = e;</span><br><span class="line">                &#125; <span class="keyword">while</span> ((e = e.next) != <span class="keyword">null</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (node != <span class="keyword">null</span> &amp;&amp; (!matchValue || (v = node.value) == value ||</span><br><span class="line">                             (value != <span class="keyword">null</span> &amp;&amp; value.equals(v)))) &#123;</span><br><span class="line">            <span class="comment">//如果命中到了对应的Node，则根据Node结构进行对应的移除操作</span></span><br><span class="line">            <span class="keyword">if</span> (node <span class="keyword">instanceof</span> TreeNode)</span><br><span class="line">                ((TreeNode&lt;K,V&gt;)node).removeTreeNode(<span class="keyword">this</span>, tab, movable);</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (node == p)</span><br><span class="line">                tab[index] = node.next;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                p.next = node.next;</span><br><span class="line">            ++modCount;</span><br><span class="line">            <span class="comment">//修改hash表元素数</span></span><br><span class="line">            --size;</span><br><span class="line">            afterNodeRemoval(node);</span><br><span class="line">            <span class="keyword">return</span> node;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="为何线程不安全？"><a class="header-anchor" href="#为何线程不安全？">¶</a>为何线程不安全？</h2>
<p>看完了HashMap的实现之后，就该谈一谈它为什么存在线程安全问题！</p>
<h3 id="数据丢失"><a class="header-anchor" href="#数据丢失">¶</a>数据丢失</h3>
<p>首先，我们将目光放在put方法的实现中，假设有两个线程在同时进行put操作，对应的数据分别为：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">thread-1： put(1, &apos;abc&apos;);</span><br><span class="line">thread-2： put(1, &apos;efg&apos;);</span><br></pre></td></tr></table></figure>
<p>假设此时Hash表的长度为10，且已经有两个元素在，负载因子为默认值0.75f，那么操作过程一定不会扩容，并且两个线程put的key都是1，那么它们将会分配到同一个table中，下方代码为put方法中的其中一段，其主要作用是遍历当前表内Node，寻找与当前key一样的Node结点，之后再做添加/更新操作。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> binCount = <span class="number">0</span>; ; ++binCount) &#123;</span><br><span class="line">   <span class="keyword">if</span> ((e = p.next) == <span class="keyword">null</span>) &#123;</span><br><span class="line">       p.next = newNode(hash, key, value, <span class="keyword">null</span>); <span class="comment">// A</span></span><br><span class="line">       <span class="keyword">if</span> (binCount &gt;= TREEIFY_THRESHOLD - <span class="number">1</span>)</span><br><span class="line">           treeifyBin(tab, hash);</span><br><span class="line">       <span class="keyword">break</span>;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">if</span> (e.hash == hash &amp;&amp;</span><br><span class="line">       ((k = e.key) == key || (key != <span class="keyword">null</span> &amp;&amp; key.equals(k))))</span><br><span class="line">       <span class="keyword">break</span>;</span><br><span class="line">   p = e;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>假设两个线程同时执行到了<code>A</code>这个位置，此时获取到的<code>p</code>是统一个对象，下一刻，cpu运转，两个线程同时运行，那么<code>p.next</code>的值将会是最后一个线程put的value值，而前一个则会丢失，这就会导致丢数据的情况！</p>
<p>当然该情景同样会发生于<code>resize</code>和<code>remove</code>操作，至于为什么，大家可以思考一下！</p>
<h3 id="size不准确"><a class="header-anchor" href="#size不准确">¶</a>size不准确</h3>
<p>这个就很简单了，为什么不准确呢，来看一下size变量在HashMap内部的定义：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">transient int size;</span><br></pre></td></tr></table></figure>
<p>内存不可见并且增减操作未加锁，多线程操作下属于非原子操作！</p>
<h3 id="闭环死锁"><a class="header-anchor" href="#闭环死锁">¶</a>闭环死锁</h3>
<p>这个问题在JDK1.8版本的HashMap中已经不存在了，至于为啥，我要先讲一下在1.8之前的HashMap为什么会存在闭环死锁问题！</p>
<p>从<code>闭环</code>这个名词上我们分析一下是什么问题，什么是闭环的，如果链表形成了一个环会不会就是闭环呢？而链表如何才会形成环？带着这些问题，我们在脑海中抽象出一个模型：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">graph LR</span><br><span class="line">A--&gt;B</span><br><span class="line">B--&gt;A</span><br></pre></td></tr></table></figure>
<p>假设某一个Table中的Node链表发生了上述问题，那么我们在遍历时进行<code>do{ }while ((e = e.next) != null);</code>操作就会发生死锁的问题，那么看来我们的猜想方向是正确的，那么我们就具体分析一下HashMap在什么操作之中会产生闭环的问题，不过在此之前，我们要明白因果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">因：???</span><br><span class="line">果：闭环</span><br></pre></td></tr></table></figure>
<p>我们知道，只有当两个结点内部的<code>next</code>相互引用对方的时候才会死锁，这种场景只能在两个已经存在同一个链上的结点同时以<code>相反的方向</code>被操作<code>next</code>引用的时候才会发生，而在HashMap内部，符合这种场景的只有一个方法：<code>resize</code>，那我们就来看一下JDK1.7的<code>resize</code>方法实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">resize</span><span class="params">(<span class="keyword">int</span> newCapacity)</span> </span>&#123;</span><br><span class="line">    Entry[] oldTable = table;</span><br><span class="line">    <span class="keyword">int</span> oldCapacity = oldTable.length;</span><br><span class="line">    <span class="keyword">if</span> (oldCapacity == MAXIMUM_CAPACITY) &#123;</span><br><span class="line">        threshold = Integer.MAX_VALUE;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Entry[] newTable = <span class="keyword">new</span> Entry[newCapacity];</span><br><span class="line">    <span class="keyword">boolean</span> oldAltHashing = useAltHashing;</span><br><span class="line">    useAltHashing |= sun.misc.VM.isBooted() &amp;&amp;</span><br><span class="line">            (newCapacity &gt;= Holder.ALTERNATIVE_HASHING_THRESHOLD);</span><br><span class="line">    <span class="keyword">boolean</span> rehash = oldAltHashing ^ useAltHashing;</span><br><span class="line">    <span class="comment">//fu</span></span><br><span class="line">    transfer(newTable, rehash);</span><br><span class="line">    table = newTable;</span><br><span class="line">    threshold = (<span class="keyword">int</span>)Math.min(newCapacity * loadFactor, MAXIMUM_CAPACITY + <span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>进入<code>transfer</code>方法中，其内部实现了扩容过程：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">transfer</span><span class="params">(Entry[] newTable, <span class="keyword">boolean</span> rehash)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> newCapacity = newTable.length;</span><br><span class="line">    <span class="keyword">for</span> (Entry&lt;K,V&gt; e : table) &#123; <span class="comment">// A</span></span><br><span class="line">        <span class="keyword">while</span>(<span class="keyword">null</span> != e) &#123;</span><br><span class="line">            Entry&lt;K,V&gt; next = e.next;</span><br><span class="line">            <span class="keyword">if</span> (rehash) &#123;</span><br><span class="line">                e.hash = <span class="keyword">null</span> == e.key ? <span class="number">0</span> : hash(e.key);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">int</span> i = indexFor(e.hash, newCapacity);</span><br><span class="line">            e.next = newTable[i];</span><br><span class="line">            newTable[i] = e;</span><br><span class="line">            e = next;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们发现，在JDK1.7的HashMap的扩容实现中，老的Table中的Node链的顺序赋值给新的Table中时的操作是反置的：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">e.next = newTable[i];</span><br><span class="line">newTable[i] = e;</span><br><span class="line">e = next;</span><br></pre></td></tr></table></figure>
<p>上述操作是将当前Node的next指针指向当前Table的头结点，之后当前Node又变为了Table的头结点，此时假设A、B两个线程同时执行到了<code>transfer</code>方法中的<code>A</code>位置，并且此时的<code>oldTable</code>和<code>newTable</code>的结构是这样的：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">oldTable[]</span><br><span class="line">table-1: a -&gt; b -&gt; c -&gt; null</span><br><span class="line">table-2: null</span><br><span class="line">table-3: null</span><br><span class="line"></span><br><span class="line">newTable[]</span><br><span class="line">table-1: null</span><br><span class="line">table-2: null</span><br><span class="line">table-3: null</span><br><span class="line">table-4: null</span><br><span class="line">table-5: null</span><br><span class="line">table-6: null</span><br></pre></td></tr></table></figure>
<p>如果很巧，两个线程在同一个CPU上执行，那么就会存在一个抢占时间片的场景，假设A先抢到了时间片，然后执行一番操作之后，<code>oldTable</code>和<code>newTable</code>的结构如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">oldTable[]</span><br><span class="line">table-1: a -&gt; null</span><br><span class="line">table-2: null</span><br><span class="line">table-3: null</span><br><span class="line"></span><br><span class="line">newTable[]</span><br><span class="line">table-1: null</span><br><span class="line">table-2: c -&gt; b -&gt; a</span><br><span class="line">table-3: null</span><br><span class="line">table-4: null</span><br><span class="line">table-5: null</span><br><span class="line">table-6: null</span><br></pre></td></tr></table></figure>
<p>之后还没等它做<code>oldTable = newTable</code>操作，B抢到了时间片，并也做了同样一番操作，<code>oldTable</code>和<code>newTable</code>的结构如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">oldTable[]</span><br><span class="line">table-1: a -&gt; null</span><br><span class="line">table-2: null</span><br><span class="line">table-3: null</span><br><span class="line"></span><br><span class="line">newTable[]</span><br><span class="line">table-1: null</span><br><span class="line">table-2: a -&gt; c -&gt; b -&gt; a</span><br><span class="line">table-3: null</span><br><span class="line">table-4: null</span><br><span class="line">table-5: null</span><br><span class="line">table-6: null</span><br></pre></td></tr></table></figure>
<p>此时A或者B谁先<code>oldTable = newTable</code>已经无所谓了，因为<code>newTable</code>中已经产生了闭环，之后在进行get或者put操作时，如果不小心触发到了while循环，那将会一直死循环：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">do</span>&#123;</span><br><span class="line">  <span class="comment">//do some thing</span></span><br><span class="line">&#125;<span class="keyword">while</span> ((e = e.next) != <span class="keyword">null</span>);  <span class="comment">//e = e.next将会永不为空</span></span><br></pre></td></tr></table></figure>
<p>从上述场景产生的过程中我们发现，<code>a -&gt; c -&gt; b -&gt; a</code>这种闭环问题的罪魁祸首是因为1.7中的HashMap在扩容时为了免去再次遍历链表，很聪明的将当前结点作为新链表的头结点，这就会导致顺序反转，所以无序化导致了闭环的产生，而这种问题不仅仅是在HashMap中体现，Mysql的死锁问题的原因常常也是因为反序加行锁导致的！</p>
<p>而在开头说过，JDK1.8已经避免了这个问题，这是为什么呢？看下代码就知道了：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">else</span> &#123; <span class="comment">// preserve order</span></span><br><span class="line">   Node&lt;K,V&gt; loHead = <span class="keyword">null</span>, loTail = <span class="keyword">null</span>;</span><br><span class="line">   Node&lt;K,V&gt; hiHead = <span class="keyword">null</span>, hiTail = <span class="keyword">null</span>;</span><br><span class="line">   Node&lt;K,V&gt; next;</span><br><span class="line">   <span class="keyword">do</span> &#123;</span><br><span class="line">       next = e.next;</span><br><span class="line">       <span class="keyword">if</span> ((e.hash &amp; oldCap) == <span class="number">0</span>) &#123;</span><br><span class="line">           <span class="keyword">if</span> (loTail == <span class="keyword">null</span>)</span><br><span class="line">               loHead = e;</span><br><span class="line">           <span class="keyword">else</span></span><br><span class="line">               loTail.next = e;</span><br><span class="line">           loTail = e;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">else</span> &#123;</span><br><span class="line">           <span class="keyword">if</span> (hiTail == <span class="keyword">null</span>)</span><br><span class="line">               hiHead = e;</span><br><span class="line">           <span class="keyword">else</span></span><br><span class="line">               hiTail.next = e;</span><br><span class="line">           hiTail = e;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125; <span class="keyword">while</span> ((e = next) != <span class="keyword">null</span>);</span><br><span class="line">   <span class="keyword">if</span> (loTail != <span class="keyword">null</span>) &#123;</span><br><span class="line">       loTail.next = <span class="keyword">null</span>;</span><br><span class="line">       newTab[j] = loHead;  <span class="comment">//A</span></span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">if</span> (hiTail != <span class="keyword">null</span>) &#123;</span><br><span class="line">       hiTail.next = <span class="keyword">null</span>;</span><br><span class="line">       newTab[j + oldCap] = hiHead; <span class="comment">//B</span></span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>同样是扩容的操作，JDK1.8中的HashMap通过两个链分别去存储头结点和尾结点以保证它有序，并且不会频繁的去赋值<code>newTable</code>，而是在循环之后直接赋值（请注意A、B标记处），这样就非常简单的避免了产生闭环的陷阱！</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/12/24/设计模式一：单例模式/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Nico">
      <meta itemprop="description" content>
      <meta itemprop="image" content="https://avatars1.githubusercontent.com/u/26395860?s=460&v=4">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Nico's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/12/24/设计模式一：单例模式/" itemprop="url">设计模式一：单例模式</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-12-24T09:33:00+08:00">
                2018-12-24
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/设计模式/" itemprop="url" rel="index">
                    <span itemprop="name">设计模式</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="什么是单例模式"><a class="header-anchor" href="#什么是单例模式">¶</a>什么是单例模式</h2>
<p>单例是最常用的设计模式之一，其表达的最主要的意思是一个对象在整个jvm堆内存中只有一个实例，这样可以保证无论从任何代码块获取的单例实例都是唯一的。</p>
<p><strong>单例的优缺点也很明显，优点有以下这些：</strong></p>
<ul>
<li>在单例模式中，活动的单例只有一个实例，对单例类的所有实例化得到的都是相同的一个实例。这样就 防止其它对象对自己的实例化，确保所有的对象都访问一个实例</li>
<li>单例模式具有一定的伸缩性，类自己来控制实例化进程，类就在改变实例化进程上有相应的伸缩性。</li>
<li>提供了对唯一实例的受控访问。</li>
<li>由于在系统内存中只存在一个对象，因此可以 节约系统资源，当 需要频繁创建和销毁的对象时单例模式无疑可以提高系统的性能。</li>
<li>允许可变数目的实例。</li>
<li>避免对共享资源的多重占用。</li>
</ul>
<p><strong>缺点：</strong></p>
<ul>
<li>不适用于变化的对象，如果同一类型的对象总是要在不同的用例场景发生变化，单例就会引起数据的错误，不能保存彼此的状态。</li>
<li>由于单利模式中没有抽象层，因此单例类的扩展有很大的困难。</li>
<li>单例类的职责过重，在一定程度上违背了“单一职责原则”。</li>
<li>滥用单例将带来一些负面问题，如为了节省资源将数据库连接池对象设计为的单例类，可能会导致共享连接池对象的程序过多而出现连接池溢出；如果实例化的对象长时间不被利用，系统会认为是垃圾而被回收，这将导致对象状态的丢失。</li>
</ul>
<p><strong>在很多场景单例模式是很有用的，例如配置容器，连接池等，在Java中获取编写一个单例也很简单（暂时屏蔽细节）：</strong></p>
<ul>
<li>第一步：私有化类构造</li>
<li>第二步：内部定义一个类型为类本身的静态私有变量</li>
<li>第三步：提供一个静态共有方法获取这个私有变量（获取之前赋值）</li>
</ul>
<p><strong>尤其是第三步，我们在获取这个私有变量的时候要对其进行赋值，那么就有两个阶段可以做这件事，</strong></p>
<ul>
<li>定义静态私有变量的时候直接赋值</li>
<li>调用公有静态方法的时候再赋值</li>
</ul>
<p>这就引出了两种实现模式：<code>饿汉模式</code>和<code>懒汉模式</code>。</p>
<h2 id="饿汉模式"><a class="header-anchor" href="#饿汉模式">¶</a>饿汉模式</h2>
<p>饿汉从字面上的意思我们可以想到一个特别饥饿的大汉，而对于单例来讲则是形容以<code>迫不及待</code>的方式去将私有实例赋值，代码实现如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">public class Single &#123;</span><br><span class="line">	private static Single instance = new Single();</span><br><span class="line">	private Single() &#123;&#125;</span><br><span class="line">	public static Single getInstance() &#123;</span><br><span class="line">		return instance;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这种模式的好处是不会存在并发下安全隐患，但是坏处也可想而知，对于jvm加载的过程就会将<code>instance</code>变量赋值，也就意味着我们即使没有用到这个单例对象也会将其实例<code>new</code>出来，可想而知，我们的永久带将会为其分配内存，带来的后果是永久带内存变少。</p>
<h2 id="懒汉模式"><a class="header-anchor" href="#懒汉模式">¶</a>懒汉模式</h2>
<p>懒汉模式则是在调用公有静态方法时才会为私有变量赋值：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">public class Single &#123;</span><br><span class="line">	private volatile static Single instance = null;// 1</span><br><span class="line">	private Single() &#123;&#125;</span><br><span class="line">	public static Single getInstance() &#123;</span><br><span class="line">		if(instance == null) &#123; //2</span><br><span class="line">			synchronized (Single.class) &#123; //3</span><br><span class="line">				if(instance == null) &#123; //4</span><br><span class="line">					instance = new Single(); // 5</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		return instance;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>相比之前的饿汉模式，我们有以下几个改动：</p>
<ul>
<li>标记1：增加volatile关键字保证<code>5</code>时不会指令重排</li>
<li>标记2：是为了提高程序的效率，当Single对象被创建以后，再获取Single对象时就不用去验证同步代码块的锁及后面的代码，直接返回Single对象</li>
<li>标记3：防止多线程下的重复执行</li>
<li>标记4：同<code>3</code>，当多个线程同时调用<code>getInstance</code>方法，此时<code>instance</code>为空，两个线程可以轻松越过<code>2</code>，来到<code>3</code>抢锁，一个线程率先抢占到并且为<code>instance</code>赋值后，如果没有<code>4</code>的<code>if</code>判断，第二个线程也会重复去为<code>instance</code>赋值，这就会导致创建多个实例。</li>
</ul>
<p>而我们使用<code>volatile</code>则是因为在标记<code>5</code>赋值的时候会发生指令重排的问题！</p>
<blockquote>
<p>在Java中看似顺序的代码在JVM中，可能会出现编译器或者CPU对这些操作指令进行了重新排序；在特定情况下，指令重排将会给我们的程序带来不确定的结果…</p>
</blockquote>
<p>对于<code>instance = new Single()</code>这一行代码，JVM执行的指令有多行：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">memory = allocate(); //1：分配对象的内存空间</span><br><span class="line">ctorInstance(memory); //2：初始化对象</span><br><span class="line">instance = memory; //3：设置instance指向刚分配的内存地址</span><br></pre></td></tr></table></figure>
<p>经重排后如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">memory = allocate(); //1：分配对象的内存空间</span><br><span class="line">instance = memory; //3：设置instance指向刚分配的内存地址，此时对象还没被初始化</span><br><span class="line">ctorInstance(memory); //2：初始化对象</span><br></pre></td></tr></table></figure>
<p>若有A线程进行完重排后的第二步，且未执行初始化对象。此时B线程来取instance时，发现instance不为空，于是便返回该值，但由于没有初始化完该对象，此时返回的对象是有问题的。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/12/11/如何使用Defender优雅的管理权限？/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Nico">
      <meta itemprop="description" content>
      <meta itemprop="image" content="https://avatars1.githubusercontent.com/u/26395860?s=460&v=4">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Nico's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/12/11/如何使用Defender优雅的管理权限？/" itemprop="url">如何使用Defender优雅的管理权限？</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-12-11T20:09:51+08:00">
                2018-12-11
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="何为权限管理"><a class="header-anchor" href="#何为权限管理">¶</a>何为权限管理</h2>
<p>权限管理已经不知不觉深入到了我们生活的每一个角落，例如地铁进站的闸机，高速公路上的过路费，停车场的杠杆等等等等。</p>
<p>作为一名开发人员，权限二字对我们的映像更加深刻，无论任何系统，都多多少少与权限管理会沾上关系！什么？你的系统和权限不沾边…好吧，你的代码拉取权限总得有吧！如果还没有的话，你登上掘金看到这篇文章并点了一个赞这个过程就需要好多次权限校验。好了扯远了，我们回归正题，这里使用一张图来简单展示web系统的权限是什么样子：</p>
<p><img src="https://user-gold-cdn.xitu.io/2018/12/11/1679cf52d7e57736?w=734&amp;h=214&amp;f=png&amp;s=18626" alt></p>
<p>看完之后，是不是感觉很简单，不错，权限管理并不难，我们只需要将<strong>校验</strong>这一环节进行开发即可，实现方式也有很多种：</p>
<h3 id="方案一：组件封装"><a class="header-anchor" href="#方案一：组件封装">¶</a>方案一：组件封装</h3>
<p>我们可以将权限校验的整个过程组件化，例如组件名为<code>AuthComponent</code>，之后再所有需要权限校验的接口对应的方法的开头，调用<code>AuthComponent</code>的<code>verify</code>方法进行校验，根据结果做不同的业务处理！</p>
<ul>
<li>优点：貌似能达到主要目的，而且非常灵活~</li>
<li>缺点：代码冗余，低内聚，高耦合，不易于维护。</li>
</ul>
<h3 id="方案二：通用处理"><a class="header-anchor" href="#方案二：通用处理">¶</a>方案二：通用处理</h3>
<p>在方案一的基础上我们稍加改造，例如使用<code>AOP</code>对需要校验的接口做个切面，在方法执行前我们使用<code>AuthComponent</code>校验一下即可，这样我们的代码就更方便维护了！</p>
<ul>
<li>优点：弥补了方案一的缺点。</li>
<li>缺点：太过通用化，很难兼容所有的情况，不灵活。</li>
</ul>
<h3 id="方案三：自定义注解"><a class="header-anchor" href="#方案三：自定义注解">¶</a>方案三：自定义注解</h3>
<p>我们将方案一和方案二结合一下，取一灵活，取二通用，我们自定义一个名为<code>@Auth</code>的注解，并且它需要传一个参数，我们这里直径定义为枚举类<code>Level</code>，简单结构如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">public enum Level &#123; LOGIN, ADMIN &#125;</span><br></pre></td></tr></table></figure>
<p>之后我们定义一个注解切面，切向携带<code>@Auth</code>的方法，在方法执行前根据value值的内容，也就是<code>Level</code>的值去做不同的权限管理即可。</p>
<ul>
<li>优点：灵活可控，通用性还行。</li>
<li>缺点：缺乏组件化，结构零散，不易复用，对于多种场景下需要制定多个切面，不优雅！</li>
</ul>
<h3 id="方案四：使用框架"><a class="header-anchor" href="#方案四：使用框架">¶</a>方案四：使用框架</h3>
<p>这是最简单的方法，例如优秀的开源<code>shiro</code>、<code>spring-Security</code>等都可以满足我们的需求，唯一的区别是框架的轻重及使用方式！</p>
<h2 id="如何更优雅的管理权限"><a class="header-anchor" href="#如何更优雅的管理权限">¶</a>如何更优雅的管理权限</h2>
<p>想必很多同学都在使用第四种方案，也有不少的小伙伴在使用方案三，对于缺点明显的方案一和二，使用的应该很少。</p>
<p>如果我们的服务并不需要那么重的权限管理框架去解决权限问题，又不想不优雅的自定义注解去实现时，我们该怎么办呢？</p>
<p>不妨试试 <a href="https://github.com/ainilili/defender" target="_blank" rel="noopener">Defender</a></p>
<h3 id="defender是什么"><a class="header-anchor" href="#defender是什么">¶</a>Defender是什么</h3>
<p><code>defender</code>是一款全面拥抱<code>spring-boot</code>的轻量级，高灵活，高可用的权限框架。如果日常中我们需要更加便捷的对服务增加权限管理，那么<code>defender</code>正合适！</p>
<p><img src="https://user-gold-cdn.xitu.io/2018/12/11/1679d0bbcd681a0d?w=871&amp;h=278&amp;f=png&amp;s=13234" alt></p>
<p>它可以免除我们重复编写自定义注解和切面，只需要调用简单的API即可灵活的指定不同模式的防御网络。</p>
<p><code>defender</code>提供很多种防御模式，我们可以通过调用简单的api是使用构建不同模式的校验器，从而迅速完成权限的管理：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">@Configuration</span><br><span class="line">@EnableDefender(&quot;* org.nico.trap.controller..*.*(..)&quot;)</span><br><span class="line">public class DefenderTestConfig &#123;</span><br><span class="line">	@Bean</span><br><span class="line">	public Defender init()&#123;</span><br><span class="line">		return Defender.getInstance()</span><br><span class="line">				.registry(Guarder.builder(GuarderType.URI)</span><br><span class="line">						.pattern(&quot;POST /user/*&quot;)</span><br><span class="line">						.preventer(caller -&gt; &#123;</span><br><span class="line">							return caller.getRequest().getHeader(&quot;token&quot;) == null </span><br><span class="line">								? Result.pass() : Result.notpass(&quot;error&quot;);</span><br><span class="line">						&#125;))</span><br><span class="line">				.ready();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上述代码的作用是对请求符合<code>POST</code>类型且URI前缀为<code>/user/</code>的所有接口做了权限管理。</p>
<p>另外，我们可以使用<code>lambda</code>简单完成权限校验逻辑，又或者使用匿名类实现复杂校验逻辑：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">Guarder.builder(GuarderType.ANNOTATION)</span><br><span class="line">		.pattern(&quot;org.nico.trap.controller&quot;)</span><br><span class="line">		.preventer(new AbstractPreventer() &#123;</span><br><span class="line">			</span><br><span class="line">			@Autowired</span><br><span class="line">			private AuthComponent authComponent;</span><br><span class="line">			</span><br><span class="line">			@Override</span><br><span class="line">			public Result detection(Caller caller) &#123;</span><br><span class="line">				String identity = caller.getAccess().value();</span><br><span class="line">				if(! identity.equals(AuthConst.VISITOR)) &#123;</span><br><span class="line">					UserBo user = authComponent.getUser();</span><br><span class="line">					if(user != null) &#123;</span><br><span class="line">						if(identity.equals(AuthConst.ADMIN))&#123;</span><br><span class="line">							if(user.getRuleType() == null) &#123;</span><br><span class="line">								return Result.notpass(new ResponseVo&lt;&gt;(ResponseCode.ERROR_ON_USER_IDENTITY_MISMATCH));</span><br><span class="line">							&#125;</span><br><span class="line">						&#125;</span><br><span class="line">					&#125;else &#123;</span><br><span class="line">						return Result.notpass(new ResponseVo&lt;&gt;(ResponseCode.ERROR_ON_LOGIN_INVALID));</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">				return Result.pass();</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;)</span><br></pre></td></tr></table></figure>
<p>其中<code>GuarderType.URI</code>和<code>GuarderType.ANNOTATION</code>分别代表URI ANT匹配模式和注解模式，后者是方案三的实现，<code>defender</code>提供简单优雅的api将各种模式的权限校验方式集合在一起。</p>
<p>相比<code>shiro</code>、<code>spring-security</code>，<code>defender</code>显得更加轻便灵活，因为它并没有提供一系列权限更具体的管理实现，而是将校验的实现开放一个接口面向开发者，总体代码大小不超过<code>21k</code>，显然对于轻量级的权限管理，<code>defender</code>更加适合！</p>
<p><code>defender</code>刚刚起步，如果大家有兴趣可以将之集成在您的开发环境尝一下鲜，项目地址如下</p>
<blockquote>
<p><a href="https://github.com/ainilili/defender" target="_blank" rel="noopener">Defender传送门</a></p>
</blockquote>
<p>官方也提供有简单的使用文档</p>
<blockquote>
<p><a href="https://github.com/ainilili/defender/blob/master/DOC_CN.md" target="_blank" rel="noopener">中文文档</a></p>
</blockquote>
<blockquote>
<p><a href="https://github.com/ainilili/defender/blob/master/DOC_EN.md" target="_blank" rel="noopener">English Document</a></p>
</blockquote>
<p>如果您感觉不错，也想参与贡献</p>
<blockquote>
<p><a href="https://github.com/ainilili/defender/blob/master/CONTRIBUTING.md" target="_blank" rel="noopener">如何贡献</a></p>
</blockquote>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/11/06/深入浅说服务如何以Jar包的方式发布/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Nico">
      <meta itemprop="description" content>
      <meta itemprop="image" content="https://avatars1.githubusercontent.com/u/26395860?s=460&v=4">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Nico's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/11/06/深入浅说服务如何以Jar包的方式发布/" itemprop="url">深入浅说服务如何以Jar包的方式发布</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-11-06T12:49:00+08:00">
                2018-11-06
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h6 id="序言"><a class="header-anchor" href="#序言">¶</a>序言</h6>
<p>笔者前段时间在使用自研框架NF( <a href="https://gitee.com/ainilili/No-Framework" target="_blank" rel="noopener">传送门</a> )开发一个自动模板生成工具之后，想将他发布到Linux下，之前一直使用IDE直接<code>run as</code>运行，在遇到发布的时候考虑过发布为war或者jar，在一番抉择之后最终选择了jar（原因是NF自带服务容器，而war为tomcat而生，所以jar更适合NF），所以特意研究了一番如何将普通项目打包成jar发布。</p>
<p>不出意外，最终我成功了，在兴奋之余，希望能够将自己实现的过程及遇到的坑记录下来，让看到有此需求的同学们少走一些弯路！</p>
<h4 id="一-何为jar"><a class="header-anchor" href="#一-何为jar">¶</a>一、何为Jar</h4>
<p>JAR 文件格式以流行的 ZIP 文件格式为基础。与 ZIP 文件不同的是，JAR 文件不仅用于压缩和发布，而且还用于部署和封装库、组件和插件程序，并可被像编译器和 JVM 这样的工具直接使用。在 JAR 中包含特殊的文件，如 manifests 和部署描述符，用来指示工具如何处理特定的 JAR。</p>
<p>更多详情通过 <a href="https://www.ibm.com/developerworks/cn/java/j-jar/index.html" target="_blank" rel="noopener">传送门</a> 查阅。</p>
<h4 id="二-发布服务的几种方案"><a class="header-anchor" href="#二-发布服务的几种方案">¶</a>二、发布服务的几种方案</h4>
<p>在web开发完成之后，我们往往想要发布服务到外网服务器中，而外网服务器大多是都是Linux系统，这时我们不能已常规方式直接在IDE中运行，需要特定几种形式去发布。</p>
<p>我们最初最常用的方式就是打包成<code>.war</code>的格式发布到Tomcat的服务容器中，这之后Tomcat会帮助我们解压war包，并加载<code>classes</code>文件夹下的<code>.class</code>到内存中，加载完毕之后，我们的服务就可以在服务器中正常运行，但是<code>.war</code>通常只适合配合Tomcat容器，对于其他服务容器，尤其是自研服务容器来讲，适用性非常差，而<code>Spring Boot</code>率先打破了常规。</p>
<p>Spring Boot采用jar的方式发布，也就是说，我们可以使用Spring Boot提供的maven插件，通过<code>mvn package</code>指令将服务打包成jar的形式发布，这就意味着服务中涉及的所有资源（class文件、依赖jar包、静态资源文件）都将会打包在一个jar包之内，在启动这个层次来讲就异常的简单了，只需要通过<code>java -jar xxxx.jar</code>的方式就可以正常启动服务，这对于我们在自己的服务器中去启动服务来说非常的方便，而Spring Boot是怎么做到这一点的呢？</p>
<p>我们来看一下Spring Boot的<code>pom.xml</code>依赖插件 <code>spring-boot-maven-plugin</code>，全配置如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;plugin&gt;</span><br><span class="line">    &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;spring-boot-maven-plugin&lt;/artifactId&gt;</span><br><span class="line">    &lt;configuration&gt;</span><br><span class="line">        &lt;mainClass&gt;$&#123;start-class&#125;&lt;/mainClass&gt;</span><br><span class="line">    &lt;/configuration&gt;</span><br><span class="line">&lt;/plugin&gt;</span><br></pre></td></tr></table></figure>
<p>我们通过之前对Jar包的了解已经得知，一个可执行jar的必要因素就是需要一个主函数入口，在上述配置中，我们可以看到很明确的主函数配置<code>&lt;mainClass&gt;${start-class}&lt;/mainClass&gt;</code>， 而占位符<code>${start-class}</code>的值就是我们平常开发中用来启动Spring Boot的主函数入口所在类，继续深入<code>spring-boot-maven-plugin</code>中，我们会看到这个插件内部依赖了更多maven自带的原生插件</p>
<ul>
<li>maven-failsafe-plugin</li>
<li>maven-jar-plugin</li>
<li>maven-surefire-plugin</li>
<li>maven-war-plugin</li>
<li>maven-resources-plugin</li>
<li>maven-shade-plugin</li>
</ul>
<p>另外少部分插件如下</p>
<ul>
<li>exec-maven-plugin</li>
<li>git-commit-id-plugin</li>
<li>spring-boot-maven-plugin 自依赖，为了支持自己的插件</li>
</ul>
<p>从以上插件列表分析，<code>spring-boot-maven-plugin</code>中包含了很多maven原生插件，支持<code>jar</code>和 <code>war</code>的格式发布，我们只站在打包可执行jar的角度来分析以上插件的作用，可以这样理解</p>
<ul>
<li>maven-jar-plugin</li>
</ul>
<blockquote>
<p>设定<code>manifest</code>中的<code>Main-Class</code>参数</p>
</blockquote>
<ul>
<li>maven-shade-plugin</li>
</ul>
<blockquote>
<p>用于把多个jar包，打成1个jar包</p>
</blockquote>
<ul>
<li>maven-resources-plugin</li>
</ul>
<blockquote>
<p>处理将项目资源（<code>src/main/</code>和 <code>src/test</code>）复制到输出目录的操作</p>
</blockquote>
<ul>
<li>maven-surefire-plugin 和 maven-failsafe-plugin</li>
</ul>
<blockquote>
<p>执行测试用例</p>
</blockquote>
<p>依赖插件的同时，<code>spring-boot-maven-plugin</code>中还使用<code>&lt;resources&gt;</code>标签来重新定义jar包内部结构。</p>
<p>以上信息是否满足将我们的服务打包成可执行jar呢？我们分析一下，如果达到我们想要的效果，我们需要</p>
<ol>
<li>自动配置主函数入口</li>
<li>静态资源打包</li>
<li>依赖打包</li>
</ol>
<p>对比上述插件，我们需要的功能都有，那么我们是否可以使用上方的插件及标签自己写个打包插件试试呢？ 当然！这里就不带着大家亲自尝试了，因为下面我要讲另一种Spring Boot没有用到的maven插件进行打包！</p>
<h4 id="三-maven-assembly-plugin-插件打包jar"><a class="header-anchor" href="#三-maven-assembly-plugin-插件打包jar">¶</a>三、maven-assembly-plugin 插件打包Jar</h4>
<p><code>maven-assembly-plugin</code>是一个超灵活maven项目打包工具，提供默认配置和自定义配置，同时提供<code>Main-Class</code>的配置、静态文件Copy及依赖打包的功能，这里是官方对于这款插件的介绍</p>
<blockquote>
<p>The Assembly Plugin for Maven is primarily intended to allow users to aggregate the project output along with its dependencies, modules, site documentation, and other files into a single distributable archive.<br>
Your project can build distribution “assemblies” easily, using one of the convenient, prefabricated assembly descriptors. These descriptors handle many common operations, such as packaging a project’s artifact along with generated documentation into a single zip archive. Alternatively, your project can provide its own descriptor and assume a much higher level of control over how dependencies, modules, file-sets, and individual files are packaged in the assembly.</p>
</blockquote>
<p>大概意思就是</p>
<p>Maven的组装插件主要是允许用户将项目输出与它的依赖项、模块、站点文档和其他文件一起集成到一个可分发的归档文件中。您的项目可以使用一种方便的预制组装描述符轻松地构建分布“程序集”。这些描述符处理许多常见的操作，例如将项目的工件连同生成的文档打包到一个zip归档文件中。或者，您的项目可以提供自己的描述符，并对依赖项、模块、文件集和各个文件如何在程序集中打包具有更高的控制级别。</p>
<p>通俗一点，你可以自定义你的项目打包格式，<code>maven-assembly-plugin</code>更像是多个打包插件的集成，并提供多种打包的文件格式，使用方面也很方便，最简单的一个使用如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">&lt;plugin&gt;</span><br><span class="line">	   &lt;artifactId&gt; maven-assembly-plugin &lt;/artifactId&gt;</span><br><span class="line">	   &lt;configuration&gt;</span><br><span class="line">			&lt;descriptorRefs&gt;</span><br><span class="line">				 &lt;descriptorRef&gt;jar-with-dependencies&lt;/descriptorRef&gt;</span><br><span class="line">			&lt;/descriptorRefs&gt;</span><br><span class="line">			&lt;archive&gt;</span><br><span class="line">				 &lt;manifest&gt;</span><br><span class="line">					  &lt;mainClass&gt;$&#123;main-class&#125;&lt;/mainClass&gt;</span><br><span class="line">				 &lt;/manifest&gt;</span><br><span class="line">			&lt;/archive&gt;</span><br><span class="line">	   &lt;/configuration&gt;</span><br><span class="line">	   &lt;executions&gt;</span><br><span class="line">			&lt;execution&gt;</span><br><span class="line">				 &lt;id&gt;make-assembly&lt;/id&gt;</span><br><span class="line">				 &lt;phase&gt;package&lt;/phase&gt;</span><br><span class="line">				 &lt;goals&gt;</span><br><span class="line">					  &lt;goal&gt;single&lt;/goal&gt;</span><br><span class="line">				 &lt;/goals&gt;</span><br><span class="line">			&lt;/execution&gt;</span><br><span class="line">	   &lt;/executions&gt;</span><br><span class="line">&lt;/plugin&gt;</span><br></pre></td></tr></table></figure>
<p><code>descriptorRefs</code>标签内部可以配置使用官方定制好的打包方式，其中如下可选配置</p>
<ul>
<li>bin</li>
<li>jar-with-dependencies</li>
<li>src</li>
<li>project<br>
不过官方定制好的有很大的局限性，我们可以将上述改成如下配置，来自定义打包方式</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">&lt;plugin&gt;</span><br><span class="line">	&lt;artifactId&gt;maven-assembly-plugin&lt;/artifactId&gt;</span><br><span class="line">	&lt;configuration&gt;</span><br><span class="line">		&lt;archive&gt;</span><br><span class="line">			&lt;manifest&gt;</span><br><span class="line">				&lt;mainClass&gt;$&#123;main-class&#125;&lt;/mainClass&gt;</span><br><span class="line">			&lt;/manifest&gt;</span><br><span class="line">		&lt;/archive&gt;</span><br><span class="line">		&lt;descriptors&gt;</span><br><span class="line">            &lt;descriptor&gt;src/main/resource/assembly-fat.xml&lt;/descriptor&gt;</span><br><span class="line">        &lt;/descriptors&gt;</span><br><span class="line">	&lt;/configuration&gt;</span><br><span class="line">	&lt;executions&gt;</span><br><span class="line">         &lt;execution&gt;</span><br><span class="line">               &lt;id&gt;make-assembly&lt;/id&gt;</span><br><span class="line">               &lt;phase&gt;package&lt;/phase&gt;</span><br><span class="line">               &lt;goals&gt;</span><br><span class="line">                    &lt;goal&gt;single&lt;/goal&gt;</span><br><span class="line">               &lt;/goals&gt;</span><br><span class="line">          &lt;/execution&gt;</span><br><span class="line">     &lt;/executions&gt;</span><br><span class="line">&lt;/plugin&gt;</span><br></pre></td></tr></table></figure>
<p>可以看出，上述配置去掉了<code>&lt;descriptorRefs&gt;</code>标签，增加了<code>&lt;descriptors&gt;</code>配置，并且子标签中还指向了<code>src/main/resource/assembly-fat.xml</code>这个配置文件，如果你的思路跟着这篇文章走，一定可以猜得到，这个配置文件就是我们自定义打包方式的入口！它的格式如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">&lt;assembly xmlns=&quot;http://maven.apache.org/ASSEMBLY/2.0.0&quot;</span><br><span class="line">    xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span><br><span class="line">    xsi:schemaLocation=&quot;http://maven.apache.org/ASSEMBLY/2.0.0 http://maven.apache.org/xsd/assembly-2.0.0.xsd&quot;&gt;</span><br><span class="line">  &lt;id&gt;distribution&lt;/id&gt;</span><br><span class="line">  </span><br><span class="line">  &lt;formats&gt;</span><br><span class="line">    &lt;format&gt;jar&lt;/format&gt;</span><br><span class="line">  &lt;/formats&gt;</span><br><span class="line">  </span><br><span class="line">  &lt;dependencySets&gt;</span><br><span class="line">		&lt;dependencySet&gt;</span><br><span class="line">			&lt;outputDirectory&gt;/&lt;/outputDirectory&gt;</span><br><span class="line">			&lt;useProjectArtifact&gt;true&lt;/useProjectArtifact&gt;</span><br><span class="line">			&lt;unpack&gt;true&lt;/unpack&gt;</span><br><span class="line">			&lt;scope&gt;runtime&lt;/scope&gt;</span><br><span class="line">		&lt;/dependencySet&gt;</span><br><span class="line">	&lt;/dependencySets&gt;</span><br><span class="line">	</span><br><span class="line">  &lt;includeBaseDirectory&gt;false&lt;/includeBaseDirectory&gt;</span><br><span class="line">  </span><br><span class="line">  &lt;fileSets&gt;</span><br><span class="line">    &lt;fileSet&gt;</span><br><span class="line">      &lt;directory&gt;$&#123;basedir&#125;&lt;/directory&gt;</span><br><span class="line">      &lt;includes&gt;</span><br><span class="line">        &lt;include&gt;*.txt&lt;/include&gt;</span><br><span class="line">      &lt;/includes&gt;</span><br><span class="line">      &lt;excludes&gt;</span><br><span class="line">        &lt;exclude&gt;README.txt&lt;/exclude&gt;</span><br><span class="line">        &lt;exclude&gt;NOTICE.txt&lt;/exclude&gt;</span><br><span class="line">      &lt;/excludes&gt;</span><br><span class="line">    &lt;/fileSet&gt;</span><br><span class="line">  &lt;/fileSets&gt;</span><br><span class="line">  </span><br><span class="line">  &lt;files&gt;</span><br><span class="line">    &lt;file&gt;</span><br><span class="line">      &lt;source&gt;README.txt&lt;/source&gt;</span><br><span class="line">      &lt;outputDirectory&gt;/&lt;/outputDirectory&gt;</span><br><span class="line">      &lt;filtered&gt;true&lt;/filtered&gt;</span><br><span class="line">    &lt;/file&gt;</span><br><span class="line">    &lt;file&gt;</span><br><span class="line">      &lt;source&gt;NOTICE.txt&lt;/source&gt;</span><br><span class="line">      &lt;outputDirectory&gt;/&lt;/outputDirectory&gt;</span><br><span class="line">      &lt;filtered&gt;true&lt;/filtered&gt;</span><br><span class="line">    &lt;/file&gt;</span><br><span class="line">  &lt;/files&gt;</span><br><span class="line">&lt;/assembly&gt;</span><br></pre></td></tr></table></figure>
<h5 id="下面是标签的相关介绍"><a class="header-anchor" href="#下面是标签的相关介绍">¶</a>下面是标签的相关介绍</h5>
<ul>
<li><code>&lt;id&gt;</code> 生成文件的后缀，如果有，文件名将会是<code>${artifactId}-${id}.jar</code></li>
<li><code>&lt;formats&gt;</code>生成文件的格式，可以同时生成多个格式的目标文件</li>
<li><code>dependencySets</code>依赖jar的打包方式</li>
<li><code>includeBaseDirectory</code>是否将项目目录引入进来，如果是<strong>True</strong>的话，生成的目标文件打开之后将会是项目主目录，我们打包的资源将会被放于这个主目录中（推荐<strong>Fasle</strong>，因为<code>Main-Class</code>路径通常直接是类路径）</li>
<li><code>&lt;fileSets&gt;</code>引入静态资源的配置（目录级）</li>
<li><code>files</code>引入静态资源的配置（文件级）</li>
</ul>
<p>以上是最常用的几种标签，更多的配置大家可以查阅官网 <a href="maven.apache.org/components/plugins/maven-assembly-plugin/">传送门</a></p>
<p>配置完成之后可以通过<code>mvn assembly:assembly</code>或者<code>mvn package</code>指令打包。</p>
<p>介绍完毕，下面会拉取笔者自己用<a href="https://gitee.com/ainilili/No-Framework" target="_blank" rel="noopener">NF</a>框架开发的模板工具来为大家演示一下<code>maven-assembly-plugin</code>在实战中的使用！</p>
<h4 id="四-jar方式发布服务实战"><a class="header-anchor" href="#四-jar方式发布服务实战">¶</a>四、Jar方式发布服务实战</h4>
<p>首先是项目结构</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Project</span><br><span class="line">│  LICENSE</span><br><span class="line">│  pom.xml								=》pom文件</span><br><span class="line">│  README.md</span><br><span class="line">├─src</span><br><span class="line">│  └─main</span><br><span class="line">│      ├─java							=》源码目录</span><br><span class="line">│      └─resource						=》配置文件目录</span><br><span class="line">└─web									=》UI静态资源</span><br></pre></td></tr></table></figure>
<p>从结构中可以看出，我们需要手动配置的打包资源是<code>src/main/resource</code>和<code>web</code>这两个目录，所以我们需要所有配置，将上述两个目录随着我们的<code>.class</code>文件一起打包进jar中，首先在原pom.xml保持不变的基础上插入<code>maven-assembly-plugin</code>插件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">&lt;plugin&gt;</span><br><span class="line">	&lt;artifactId&gt;maven-assembly-plugin&lt;/artifactId&gt;</span><br><span class="line">	&lt;configuration&gt;</span><br><span class="line">		&lt;source&gt;1.8&lt;/source&gt;</span><br><span class="line">		&lt;target&gt;1.8&lt;/target&gt;</span><br><span class="line">		&lt;archive&gt;</span><br><span class="line">			&lt;manifest&gt;</span><br><span class="line">				&lt;mainClass&gt;org.nico.ct.CtApplication&lt;/mainClass&gt;</span><br><span class="line">			&lt;/manifest&gt;</span><br><span class="line">		&lt;/archive&gt;</span><br><span class="line">		&lt;descriptors&gt;</span><br><span class="line">			&lt;descriptor&gt;src/main/resource/assembly-fat.xml&lt;/descriptor&gt;</span><br><span class="line">		&lt;/descriptors&gt;</span><br><span class="line">	&lt;/configuration&gt;</span><br><span class="line">	&lt;executions&gt;</span><br><span class="line">		&lt;execution&gt;</span><br><span class="line">			 &lt;id&gt;make-assembly&lt;/id&gt;</span><br><span class="line">			 &lt;phase&gt;package&lt;/phase&gt;</span><br><span class="line">			 &lt;goals&gt;</span><br><span class="line">				  &lt;goal&gt;single&lt;/goal&gt;</span><br><span class="line">			 &lt;/goals&gt;</span><br><span class="line">		&lt;/execution&gt;</span><br><span class="line">   &lt;/executions&gt;</span><br><span class="line">&lt;/plugin&gt;</span><br></pre></td></tr></table></figure>
<p>接下来编辑<code>src/main/resource/assembly-fat.xml</code>文件配置打包</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">&lt;assembly</span><br><span class="line">	xmlns=&quot;http://maven.apache.org/plugins/maven-assembly-plugin/assembly/1.1.3&quot;</span><br><span class="line">	xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span><br><span class="line">	xsi:schemaLocation=&quot;http://maven.apache.org/plugins/maven-assembly-plugin/assembly/1.1.3 http://maven.apache.org/xsd/assembly-1.1.3.xsd&quot;&gt;</span><br><span class="line">	&lt;id&gt;RELEASE&lt;/id&gt;</span><br><span class="line"></span><br><span class="line">	&lt;formats&gt;</span><br><span class="line">		&lt;format&gt;jar&lt;/format&gt;</span><br><span class="line">	&lt;/formats&gt;</span><br><span class="line"></span><br><span class="line">	&lt;dependencySets&gt;</span><br><span class="line">		&lt;dependencySet&gt;</span><br><span class="line">			&lt;outputDirectory&gt;/&lt;/outputDirectory&gt;</span><br><span class="line">			&lt;useProjectArtifact&gt;true&lt;/useProjectArtifact&gt;</span><br><span class="line">			&lt;unpack&gt;true&lt;/unpack&gt;</span><br><span class="line">			&lt;scope&gt;runtime&lt;/scope&gt;</span><br><span class="line">		&lt;/dependencySet&gt;</span><br><span class="line">	&lt;/dependencySets&gt;</span><br><span class="line">	</span><br><span class="line">	&lt;includeBaseDirectory&gt;false&lt;/includeBaseDirectory&gt;</span><br><span class="line">	</span><br><span class="line">	&lt;fileSets&gt;</span><br><span class="line">		&lt;fileSet&gt;</span><br><span class="line">			&lt;directory&gt;src/main/resource&lt;/directory&gt;</span><br><span class="line">			&lt;outputDirectory&gt;/&lt;/outputDirectory&gt;</span><br><span class="line">			&lt;includes&gt;</span><br><span class="line">				&lt;include&gt;/**&lt;/include&gt;</span><br><span class="line">			&lt;/includes&gt;</span><br><span class="line">		&lt;/fileSet&gt;</span><br><span class="line">		&lt;fileSet&gt;</span><br><span class="line">			&lt;directory&gt;web&lt;/directory&gt;</span><br><span class="line">			&lt;outputDirectory&gt;/web&lt;/outputDirectory&gt;</span><br><span class="line">			&lt;includes&gt;</span><br><span class="line">				&lt;include&gt;/**&lt;/include&gt;</span><br><span class="line">			&lt;/includes&gt;</span><br><span class="line">		&lt;/fileSet&gt;</span><br><span class="line">	&lt;/fileSets&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	&lt;files&gt;</span><br><span class="line">		&lt;file&gt;</span><br><span class="line">			&lt;source&gt;README.md&lt;/source&gt;</span><br><span class="line">			&lt;outputDirectory&gt;/&lt;/outputDirectory&gt;</span><br><span class="line">		&lt;/file&gt;</span><br><span class="line">	&lt;/files&gt;</span><br><span class="line"></span><br><span class="line">&lt;/assembly&gt;</span><br></pre></td></tr></table></figure>
<p>然后运行<code>mvn assembly:assembly</code>，等待maven构建成功</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">[INFO] META-INF/ already added, skipping</span><br><span class="line">[INFO] META-INF/MANIFEST.MF already added, skipping</span><br><span class="line">[INFO] org/ already added, skipping</span><br><span class="line">[INFO] org/nico/ already added, skipping</span><br><span class="line">[INFO] META-INF/maven/ already added, skipping</span><br><span class="line">[INFO] ------------------------------------------------------------------------</span><br><span class="line">[INFO] BUILD SUCCESS</span><br><span class="line">[INFO] ------------------------------------------------------------------------</span><br><span class="line">[INFO] Total time: 7.627 s</span><br><span class="line">[INFO] Finished at: 2018-06-30T15:39:47+08:00</span><br><span class="line">[INFO] Final Memory: 24M/269M</span><br><span class="line">[INFO] ------------------------------------------------------------------------</span><br></pre></td></tr></table></figure>
<p>看到<code>BUILD SUCCESS</code>之后，你会发现项目target目录中会有两个jar</p>
<ul>
<li>CoffeeTime-0.0.1-SNAPSHOT.jar</li>
<li>CoffeeTime-0.0.1-SNAPSHOT-RELEASE.jar</li>
</ul>
<p>文件名请忽略，后缀带<code>RELEASE</code>的jar就是<code>maven-assembly-plugin</code>插件生成的jar，解压看下目录</p>
<pre><code>│  assembly-fat.xml
│  cat-mysql-nico.xml
│  cat-mysql.xml
│  cat-redis-nico.xml
│  cat-redis.xml
│  cat.xml
│  logno.properties
│  module-info.class
│  README.md
├─com
│  ├─mchange
│  │ 
│  └─mysql  
├─images
├─META-INF
│  ├─maven
│  │ 
│  └─services
├─net
│  └─sf    
├─org
│  ├─apache
│  │  
│  ├─gjt
│  │ 
│  ├─nico
│  ├─objectweb
│  └─slf4j
│ 
├─redis
│  └─clients
│
└─web
    ├─images
    ├─page 
    ├─plugins  
    ├─script
    ├─style
    ├─video
    └─videojs
</code></pre>
<p>路径没问题，我们试下能不能运行，切到jar包所在的目录，执行<code>jar -jar CoffeeTime-0.0.1-SNAPSHOT-RELEASE.jar</code>运行之<br>
<img src="https://user-gold-cdn.xitu.io/2018/11/6/166e78328722cfc4?w=1389&amp;h=752&amp;f=png&amp;s=66225" alt="这里写图片描述"></p>
<p>SUCCESS !</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/11/06/Linux平台Nginx的安装及使用/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Nico">
      <meta itemprop="description" content>
      <meta itemprop="image" content="https://avatars1.githubusercontent.com/u/26395860?s=460&v=4">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Nico's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/11/06/Linux平台Nginx的安装及使用/" itemprop="url">Linux平台Nginx的安装及使用</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-11-06T12:49:00+08:00">
                2018-11-06
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>这几天因为需要部署静态资源服务器，所以就找了个vps部署一下Nginx，顺带将vsftpd配置好了，下面就给大家讲一下如何在CentOS上部署Nginx及vsftpd！</p>
<p>如果大家不知道Nginx和vsftpd的用处，请自行百度，这里就不过多介绍，废话少说，进入正题。</p>
<h2 id="一-在centos上下载nginx和vsftpd"><a class="header-anchor" href="#一-在centos上下载nginx和vsftpd">¶</a>一、在CentOS上下载Nginx和vsftpd</h2>
<p>常用的Nginx下载方式有两种，一种是使用CentOS上自带的yum下载，第二种是从网上下载后在通过make进行编译安装，下面我将会向大家介绍一下这两种安装方式</p>
<h3 id="1-yum安装方式"><a class="header-anchor" href="#1-yum安装方式">¶</a>1、yum安装方式</h3>
<p>首先我们更新一下yum软件库</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum update</span><br></pre></td></tr></table></figure>
<p>然后我们搜索一下yum库关于nginx的rpm包</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum list | grep nginx</span><br></pre></td></tr></table></figure>
<p>可以看到下面的列表</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@VM_239_130_centos html]# yum list | grep nginx</span><br><span class="line">nginx-filesystem.noarch                     1.10.2-1.el6                 @epel  </span><br><span class="line">collectd-nginx.x86_64                       4.10.9-4.el6                 epel   </span><br><span class="line">munin-nginx.noarch                          2.0.33-1.el6                 epel   </span><br><span class="line">nginx.x86_64                                1.10.2-1.el6                 epel   </span><br><span class="line">nginx-all-modules.noarch                    1.10.2-1.el6                 epel   </span><br><span class="line">nginx-mod-http-geoip.x86_64                 1.10.2-1.el6                 epel   </span><br><span class="line">nginx-mod-http-image-filter.x86_64          1.10.2-1.el6                 epel   </span><br><span class="line">nginx-mod-http-perl.x86_64                  1.10.2-1.el6                 epel   </span><br><span class="line">nginx-mod-http-xslt-filter.x86_64           1.10.2-1.el6                 epel   </span><br><span class="line">nginx-mod-mail.x86_64                       1.10.2-1.el6                 epel   </span><br><span class="line">nginx-mod-stream.x86_64                     1.10.2-1.el6                 epel   </span><br><span class="line">pcp-pmda-nginx.x86_64                       3.10.9-9.el6                 os</span><br></pre></td></tr></table></figure>
<p>接下来我们选择使用yum安装<code>nginx.x86_64 1.10.2-1.el6 epel</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install nginx</span><br></pre></td></tr></table></figure>
<p>中间会提示我们一次是否确认安装</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">=======================================================================================================================</span><br><span class="line"> Package                                   Arch                 Version                       Repository          Size</span><br><span class="line">=======================================================================================================================</span><br><span class="line">Installing:</span><br><span class="line"> nginx                                     x86_64               1.10.2-1.el6                  epel               462 k</span><br><span class="line">Installing for dependencies:</span><br><span class="line"> nginx-all-modules                         noarch               1.10.2-1.el6                  epel               7.7 k</span><br><span class="line"> nginx-mod-http-geoip                      x86_64               1.10.2-1.el6                  epel                14 k</span><br><span class="line"> nginx-mod-http-image-filter               x86_64               1.10.2-1.el6                  epel                16 k</span><br><span class="line"> nginx-mod-http-perl                       x86_64               1.10.2-1.el6                  epel                26 k</span><br><span class="line"> nginx-mod-http-xslt-filter                x86_64               1.10.2-1.el6                  epel                16 k</span><br><span class="line"> nginx-mod-mail                            x86_64               1.10.2-1.el6                  epel                43 k</span><br><span class="line"> nginx-mod-stream                          x86_64               1.10.2-1.el6                  epel                36 k</span><br><span class="line"></span><br><span class="line">Transaction Summary</span><br><span class="line">=======================================================================================================================</span><br><span class="line">Install       8 Package(s)</span><br><span class="line"></span><br><span class="line">Total download size: 620 k</span><br><span class="line">Installed size: 1.6 M</span><br><span class="line">Is this ok [y/N]:</span><br></pre></td></tr></table></figure>
<p>输入<code>y</code>继续</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Installed:</span><br><span class="line">  nginx.x86_64 0:1.10.2-1.el6                                                                                          </span><br><span class="line"></span><br><span class="line">Dependency Installed:</span><br><span class="line">  nginx-all-modules.noarch 0:1.10.2-1.el6                       nginx-mod-http-geoip.x86_64 0:1.10.2-1.el6            </span><br><span class="line">  nginx-mod-http-image-filter.x86_64 0:1.10.2-1.el6             nginx-mod-http-perl.x86_64 0:1.10.2-1.el6             </span><br><span class="line">  nginx-mod-http-xslt-filter.x86_64 0:1.10.2-1.el6              nginx-mod-mail.x86_64 0:1.10.2-1.el6                  </span><br><span class="line">  nginx-mod-stream.x86_64 0:1.10.2-1.el6                       </span><br><span class="line"></span><br><span class="line">Complete!</span><br></pre></td></tr></table></figure>
<p>安装完毕！！接下来我们来看一下nginx的文件分布</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">whereis nginx</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@VM_239_130_centos html]# whereis nginx</span><br><span class="line">nginx: /usr/sbin/nginx /etc/nginx /usr/lib64/nginx /usr/local/nginx /usr/share/nginx /usr/share/man/man3/nginx.3pm.gz /usr/share/man/man8/nginx.8.gz</span><br></pre></td></tr></table></figure>
<p>其中三个文件（夹）比较重要：</p>
<table>
<thead>
<tr>
<th>路径</th>
<th>作用</th>
</tr>
</thead>
<tbody>
<tr>
<td>/usr/sbin/nginx</td>
<td>nginx启动路径</td>
</tr>
<tr>
<td>/etc/nginx</td>
<td>存放nginx的配置文件</td>
</tr>
<tr>
<td>/usr/share/nginx</td>
<td>默认的nginx资源库</td>
</tr>
</tbody>
</table>
<p>我们首先进入<code>/etc/nginx/</code>中看一下nginx到底有哪些配置文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@VM_239_130_centos html]# cd /etc/nginx</span><br><span class="line">[root@VM_239_130_centos nginx]# ls</span><br><span class="line">conf.d        fastcgi.conf.default    koi-utf     mime.types.default  scgi_params          uwsgi_params.default</span><br><span class="line">default.d     fastcgi_params          koi-win     nginx.conf          scgi_params.default  win-utf</span><br><span class="line">fastcgi.conf  fastcgi_params.default  mime.types  nginx.conf.default  uwsgi_params</span><br></pre></td></tr></table></figure>
<p>哇，看到这么多配置文件是不是吓了一跳，其实我们只需要在意nginx.conf就行了，其他的涉及到了再百度，接下来我们进入nginx.conf(这里我们使用vim，系统没有vim的小伙伴可以使用<code>yum install vim</code>进行下载安装)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim nginx.conf</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">http &#123;</span><br><span class="line">    log_format  main  &apos;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &apos;  #日志格式</span><br><span class="line">                      &apos;$status $body_bytes_sent &quot;$http_referer&quot; &apos;</span><br><span class="line">                      &apos;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;&apos;;</span><br><span class="line"></span><br><span class="line">    access_log  /var/log/nginx/access.log  main;                                                  #操作成功记录日志</span><br><span class="line"></span><br><span class="line">    sendfile            on;</span><br><span class="line">    tcp_nopush          on;</span><br><span class="line">    tcp_nodelay         on;</span><br><span class="line">    keepalive_timeout   65;</span><br><span class="line">    types_hash_max_size 2048;</span><br><span class="line"></span><br><span class="line">    include             /etc/nginx/mime.types;</span><br><span class="line">    default_type        application/octet-stream;</span><br><span class="line"></span><br><span class="line">    # Load modular configuration files from the /etc/nginx/conf.d directory.</span><br><span class="line">    # See http://nginx.org/en/docs/ngx_core_module.html#include</span><br><span class="line">    # for more information.</span><br><span class="line">    include /etc/nginx/conf.d/*.conf;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上面的配置不要动，我们跟踪到这一行<code>include /etc/nginx/conf.d/*.conf</code>主要作用就是加载更多的配置文件，我们退出vim编辑<code>ESC+:q</code>进入到conf.d文件夹来看一下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@VM_239_130_centos nginx]# cd /etc/nginx/conf.d</span><br><span class="line">[root@VM_239_130_centos conf.d]# ls</span><br><span class="line">default.conf  default.conf.rpmsave  ssl.conf  virtual.conf</span><br></pre></td></tr></table></figure>
<p>然后进入default.conf</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim default.conf</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">#</span><br><span class="line"># The default server</span><br><span class="line">#</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">    listen       80 default_server;</span><br><span class="line">    listen       [::]:80 default_server;</span><br><span class="line">    server_name  _;</span><br><span class="line">    root         /usr/share/nginx/html;</span><br><span class="line"></span><br><span class="line">    # Load configuration files for the default server block.</span><br><span class="line">    include /etc/nginx/default.d/*.conf;</span><br><span class="line"></span><br><span class="line">    location / &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    error_page 404 /404.html;</span><br><span class="line">        location = /40x.html &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    error_page 500 502 503 504 /50x.html;</span><br><span class="line">        location = /50x.html &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们发现这个文件配置的是server{}，server的配置就是我们nginx的核心配置，这里先不过多的讲，下面会详细介绍server的配置，但是此时如果我们运行nginx的话将会报错</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Address family not supported by protocol</span><br></pre></td></tr></table></figure>
<p>我们需要将上面的</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">listen       [::]:80 default_server;</span><br></pre></td></tr></table></figure>
<p>注释掉</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># listen       [::]:80 default_server;</span><br></pre></td></tr></table></figure>
<p>退出vim编辑，使用<code>/usr/sbin/nginx</code>启动nginx</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@VM_239_130_centos conf.d]# /usr/sbin/nginx</span><br></pre></td></tr></table></figure>
<p>关闭nginx</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pkill -9 nginx</span><br></pre></td></tr></table></figure>
<h3 id="2-编译安装"><a class="header-anchor" href="#2-编译安装">¶</a>2、编译安装</h3>
<p>这里借鉴了腾讯云论坛上的一个帖子： <a href="http://bbs.qcloud.com/thread-10429-1-1.html" target="_blank" rel="noopener">CentOS 7中Nginx1.9.5编译安装教程systemctl启动</a></p>
<p><font color="#555555">先安装gcc 等</font></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum -y install gcc gcc-c++ wget</span><br></pre></td></tr></table></figure>
<p><font>.然后装一些库</font></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum -y install gcc wget automake autoconf libtool libxml2-devel libxslt-devel perl-devel perl-ExtUtils-Embed pcre-devel openssl-devel</span><br></pre></td></tr></table></figure>
<p><font color="#555555">进入默认的软件目录</font></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cd /usr/local/src/</span><br></pre></td></tr></table></figure>
<p><font color="#555555">下载 nginx软件</font></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget http://nginx.org/download/nginx-1.9.5.tar.gz</span><br></pre></td></tr></table></figure>
<p><span style="color: rgb(68, 68, 68); font-size: 14px;">如果这个下载太慢可以在这里下载</span><font><a href="http://nginx.org/download/nginx-1.9.5.tar.gz" target="_blank" rel="noopener">http://nginx.org/download/nginx-1.9.5.tar.gz</a> 下载完后yum -y intall lrzsz 装好上传工具</font></p>
<p><font>然后用rz上传到服务器</font> <font color="#555555">然后解压文件.</font></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tar zxvf nginx-1.9.5.tar.gz</span><br></pre></td></tr></table></figure>
<p><font color="#555555">进入 nginx1.9.5的源码 如果想改版本号 可以进入源码目录</font><font color="#555555">src/core/nginx.h</font><font color="#555555">更改</font></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cd nginx-1.9.5/</span><br></pre></td></tr></table></figure>
<p><font color="#555555">创建一个nginx目录用来存放运行的临时文件夹</font></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /var/cache/nginx</span><br></pre></td></tr></table></figure>
<p><font color="#555555">开始configure</font></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">./configure \</span><br><span class="line">--prefix=/usr/local/nginx \</span><br><span class="line">--sbin-path=/usr/sbin/nginx \</span><br><span class="line">--conf-path=/etc/nginx/nginx.conf \</span><br><span class="line">--error-log-path=/var/log/nginx/error.log \</span><br><span class="line">--http-log-path=/var/log/nginx/access.log \</span><br><span class="line">--pid-path=/var/run/nginx.pid \</span><br><span class="line">--lock-path=/var/run/nginx.lock \</span><br><span class="line">--http-client-body-temp-path=/var/cache/nginx/client_temp \</span><br><span class="line">--http-proxy-temp-path=/var/cache/nginx/proxy_temp \</span><br><span class="line">--http-fastcgi-temp-path=/var/cache/nginx/fastcgi_temp \</span><br><span class="line">--http-uwsgi-temp-path=/var/cache/nginx/uwsgi_temp \</span><br><span class="line">--http-scgi-temp-path=/var/cache/nginx/scgi_temp \</span><br><span class="line">--user=nobody \</span><br><span class="line">--group=nobody \</span><br><span class="line">--with-pcre \</span><br><span class="line">--with-http_v2_module \</span><br><span class="line">--with-http_ssl_module \</span><br><span class="line">--with-http_realip_module \</span><br><span class="line">--with-http_addition_module \</span><br><span class="line">--with-http_sub_module \</span><br><span class="line">--with-http_dav_module \</span><br><span class="line">--with-http_flv_module \</span><br><span class="line">--with-http_mp4_module \</span><br><span class="line">--with-http_gunzip_module \</span><br><span class="line">--with-http_gzip_static_module \</span><br><span class="line">--with-http_random_index_module \</span><br><span class="line">--with-http_secure_link_module \</span><br><span class="line">--with-http_stub_status_module \</span><br><span class="line">--with-http_auth_request_module \</span><br><span class="line">--with-mail \</span><br><span class="line">--with-mail_ssl_module \</span><br><span class="line">--with-file-aio \</span><br><span class="line">--with-ipv6 \</span><br><span class="line">--with-http_v2_module \</span><br><span class="line">--with-threads \</span><br><span class="line">--with-stream \</span><br><span class="line">--with-stream_ssl_module</span><br></pre></td></tr></table></figure>
<p><span style="color: rgb(68, 68, 68); font-size: 14px;">接着 编译</span></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">make</span><br></pre></td></tr></table></figure>
<p><span style="color: rgb(68, 68, 68); font-size: 14px;">安装</span></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">make install</span><br></pre></td></tr></table></figure>
<p><font color="#555555">启动nginx</font></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/sbin/nginx</span><br></pre></td></tr></table></figure>
<p><font color="#555555">用ps aux来查看nginx是否启动</font></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ps aux|grep nginx</span><br></pre></td></tr></table></figure>
<p><span style="font-size: 12px;">复制代码</span></p>
<p><span style="color: rgb(68, 68, 68); font-size: 14px;">然后配置服务</span></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /usr/lib/systemd/system/nginx.service</span><br></pre></td></tr></table></figure>
<p><font color="#555555">按i输入以下内容</font></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[Unit]</span><br><span class="line">Description=nginx - high performance web server </span><br><span class="line">Documentation=http://nginx.org/en/docs/</span><br><span class="line">After=network.target remote-fs.target nss-lookup.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type=forking</span><br><span class="line">PIDFile=/var/run/nginx.pid</span><br><span class="line">ExecStartPre=/usr/sbin/nginx -t -c /etc/nginx/nginx.conf</span><br><span class="line">ExecStart=/usr/sbin/nginx -c /etc/nginx/nginx.conf</span><br><span class="line">ExecReload=/bin/kill -s HUP $MAINPID</span><br><span class="line">ExecStop=/bin/kill -s QUIT $MAINPID</span><br><span class="line">PrivateTmp=true</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure>
<p><font color="#555555">编辑好后保存</font><font color="#555555">然后开启开机启动</font></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl enable nginx.service</span><br></pre></td></tr></table></figure>
<p><font color="#555555">用命令关掉nginx</font></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pkill -9 nginx</span><br></pre></td></tr></table></figure>
<p><font color="#555555">后面可以用systemctl来操作nginx.service</font></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl start nginx.service</span><br></pre></td></tr></table></figure>
<p>这里值得一提的是nginx编译安装后的文件夹和yum安装的文件夹类似，nginx.conf文件都在/etc/nginx下，不过编译安装后的nginx.conf文件内部配置与yum安装略有差异</p>
<p>编译安装后的nginx.conf内部直接配置server，所以编译安装的小伙伴配置server就不用去改/etc/nginx/conf.d下的default.conf文件配置了，直接到nginx.conf文件中改server配置就行了</p>
<h2 id="二-nginx配置详解"><a class="header-anchor" href="#二-nginx配置详解">¶</a>二、Nginx配置详解</h2>
<p>1、全局块：配置影响nginx全局的指令。一般有运行nginx服务器的用户组，nginx进程pid存放路径，日志存放路径，配置文件引入，允许生成worker process数等。</p>
<p>2、events块：配置影响nginx服务器或与用户的网络连接。有每个进程的最大连接数，选取哪种事件驱动模型处理连接请求，是否允许同时接受多个网路连接，开启多个网络连接序列化等。</p>
<p>3、http块：可以嵌套多个server，配置代理，缓存，日志定义等绝大多数功能和第三方模块的配置。如文件引入，mime-type定义，日志自定义，是否使用sendfile传输文件，连接超时时间，单连接请求数等。</p>
<p>4、server块：配置虚拟主机的相关参数，一个http中可以有多个server。</p>
<p>5、location块：配置请求的路由，以及各种页面的处理情况。</p>
<p>我们来到yum安装后的<code>/etc/nginx/conf.d/default.conf</code>文件中</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    listen       80 default_server;</span><br><span class="line">   # listen       [::]:80 default_server;</span><br><span class="line">    server_name  _;</span><br><span class="line">    root         /usr/share/nginx/html;</span><br><span class="line"></span><br><span class="line">    # Load configuration files for the default server block.</span><br><span class="line">    include /etc/nginx/default.d/*.conf;</span><br><span class="line"></span><br><span class="line">    location / &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    error_page 404 /404.html;</span><br><span class="line">        location = /40x.html &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    error_page 500 502 503 504 /50x.html;</span><br><span class="line">        location = /50x.html &#123;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>在server块中</p>
<table>
<thead>
<tr>
<th>名称</th>
<th>作用</th>
</tr>
</thead>
<tbody>
<tr>
<td>listen</td>
<td>nginx监听端口</td>
</tr>
<tr>
<td>root</td>
<td>nginx资源路径根目录</td>
</tr>
<tr>
<td>location</td>
<td>url访问的本地资源路径配置(支持通配符)</td>
</tr>
<tr>
<td></td>
<td></td>
</tr>
<tr>
<td>error_page</td>
<td>跳转报错页面</td>
</tr>
</tbody>
</table>
<p>其中nginx会在资源目录中去找默认的index.html页面，我们进入/usr/share/nginx/html中看一下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@VM_239_130_centos conf.d]# cd /usr/share/nginx/html</span><br><span class="line"></span><br><span class="line">[root@VM_239_130_centos html]# ls</span><br><span class="line"></span><br><span class="line">404.html  50x.html  index.html  nginx-logo.png  poweredby.png</span><br></pre></td></tr></table></figure>
<p>我们在这个文件夹中创建一个test.html</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@VM_239_130_centos html]# touch test.html</span><br><span class="line"></span><br><span class="line">[root@VM_239_130_centos html]# ls</span><br><span class="line"></span><br><span class="line">404.html  50x.html  hello  index.html  nginx-logo.png  poweredby.png test.html  world</span><br></pre></td></tr></table></figure>
<p>html页面内容</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&lt;html&gt;</span><br><span class="line">        &lt;head&gt;</span><br><span class="line">                &lt;title&gt;test&lt;/title&gt;</span><br><span class="line">        &lt;/head&gt;</span><br><span class="line">        &lt;body&gt;  </span><br><span class="line">                &lt;h1&gt;hello world&lt;/h1&gt;</span><br><span class="line">        &lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>
<p>然后我们在浏览器上去访问test.html</p>
<p>成功~</p>
<p>然后我们修改一下default.conf的配置，增加一个location</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@VM_239_130_centos html]# vim /etc/nginx/conf.d/default.conf</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">#</span><br><span class="line"># The default server</span><br><span class="line">#</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">    listen       80 default_server;</span><br><span class="line">   # listen       [::]:80 default_server;</span><br><span class="line">    server_name  _;</span><br><span class="line">    root         /usr/share/nginx/html;</span><br><span class="line"></span><br><span class="line">    # Load configuration files for the default server block.</span><br><span class="line">    include /etc/nginx/default.d/*.conf;</span><br><span class="line"></span><br><span class="line">    location / &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    location /test&#123;</span><br><span class="line">        #root /;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    error_page 404 /404.html;</span><br><span class="line">        location = /40x.html &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    error_page 500 502 503 504 /50x.html;</span><br><span class="line">        location = /50x.html &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>保存退出然后关闭nginx后重新运行</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@VM_239_130_centos html]# pkill -9 nginx</span><br><span class="line">[root@VM_239_130_centos html]# /usr/sbin/nginx</span><br></pre></td></tr></table></figure>
<p>然后我们访问test/test.html</p>
<p><img src="http://nginx.ikuvn.com/images/261498318719617.jpg" alt="Clipboard Image.png"></p>
<p>不料却报错了，找不到网页，这是因为我们新添加了一个location资源路径的配置，他会自动找到root，然后在去找root下面是否有test这个文件夹，有的话就去test文件夹中去找我们访问的test.html，可想而知，我们并没有建立test文件夹</p>
<p>回到 /usr/share/nginx/html，然后建立test文件夹，将test.html移动到test文件夹中</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@VM_239_130_centos html]# mkdir test</span><br><span class="line">[root@VM_239_130_centos html]# mv test.html test/test.html</span><br><span class="line">[root@VM_239_130_centos html]# ls</span><br><span class="line">404.html  50x.html  hello  index.html  nginx-logo.png  poweredby.png  test  world</span><br><span class="line">[root@VM_239_130_centos html]# cd test</span><br><span class="line">[root@VM_239_130_centos test]# ls</span><br><span class="line">test.html</span><br></pre></td></tr></table></figure>
<p>这里要注意一下，我增加的location配置是这样的</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">location /test&#123;</span><br><span class="line">        #root /;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>如果这个root配置不注释的话将会覆盖server块下的root路径哦，到这里nginx基本配置应该就写完了，大家可以去亲自试一试~</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/11/06/Spring-Cloud-Config-入门/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Nico">
      <meta itemprop="description" content>
      <meta itemprop="image" content="https://avatars1.githubusercontent.com/u/26395860?s=460&v=4">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Nico's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/11/06/Spring-Cloud-Config-入门/" itemprop="url">Spring Cloud Config 入门</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-11-06T12:47:00+08:00">
                2018-11-06
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="一-依赖配置"><a class="header-anchor" href="#一-依赖配置">¶</a>一、依赖配置</h2>
<p>Maven依赖配置只是配置中心需要的配置，其他配置自加，本文仅以扩展为目标~</p>
<h4 id="客户端"><a class="header-anchor" href="#客户端">¶</a>客户端</h4>
<p>Maven配置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">   &lt;dependency&gt;</span><br><span class="line">	&lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;</span><br><span class="line">	&lt;artifactId&gt;spring-cloud-starter-config&lt;/artifactId&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>
<p>Main</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">@SpringBootApplication</span><br><span class="line">@EnableConfigServer</span><br><span class="line">public class ConfigApp &#123;</span><br><span class="line">	</span><br><span class="line">	public static void main(String[] args) throws Exception &#123;</span><br><span class="line">		SpringApplication.run(ConfigApp.class, args);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>application.yml</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">server:</span><br><span class="line">  port: 8087</span><br><span class="line">spring:</span><br><span class="line">  cloud:</span><br><span class="line">    config:</span><br><span class="line">      label: master</span><br><span class="line">      server:</span><br><span class="line">        git:</span><br><span class="line">          uri: git配置仓库http地址</span><br><span class="line">          username: xxx</span><br><span class="line">          password: xxx</span><br></pre></td></tr></table></figure>
<h4 id="配置服务端"><a class="header-anchor" href="#配置服务端">¶</a>配置服务端</h4>
<p>Maven配置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">   &lt;dependency&gt;</span><br><span class="line">	&lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;</span><br><span class="line">	&lt;artifactId&gt;spring-cloud-config-server&lt;/artifactId&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>
<p>application.yml</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">spring:</span><br><span class="line">  cloud:</span><br><span class="line">    config:</span><br><span class="line">      profile: dev</span><br><span class="line">      label: master</span><br><span class="line">      uri: http://localhost:8087/</span><br></pre></td></tr></table></figure>
<h2 id="二-映射规则"><a class="header-anchor" href="#二-映射规则">¶</a>二、映射规则</h2>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">/&#123;application&#125;/&#123;profile&#125;[/&#123;label&#125;]</span><br><span class="line">/&#123;application&#125;-&#123;profile&#125;.yml</span><br><span class="line">/&#123;application&#125;-&#123;profile&#125;.properties</span><br><span class="line">/&#123;label&#125;/&#123;application&#125;-&#123;profile&#125;.yml</span><br><span class="line">/&#123;label&#125;/&#123;application&#125;-&#123;profile&#125;.properties</span><br></pre></td></tr></table></figure>
<p>application：服务名<br>
profile：环境<code>dev/test/pro</code><br>
lable：分支</p>
<p>仓库根目录下可以用<code>application.yml</code>作为全局配置，所有服务共享</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/11/06/Jenkins安装及自动部署Maven项目/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Nico">
      <meta itemprop="description" content>
      <meta itemprop="image" content="https://avatars1.githubusercontent.com/u/26395860?s=460&v=4">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Nico's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/11/06/Jenkins安装及自动部署Maven项目/" itemprop="url">Jenkins安装及自动部署Maven项目</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-11-06T12:47:00+08:00">
                2018-11-06
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="一-环境配置"><a class="header-anchor" href="#一-环境配置">¶</a>一、环境配置</h2>
<h4 id="os版本"><a class="header-anchor" href="#os版本">¶</a>OS版本</h4>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@VM_0_11_centos /]# rpm -qa | grep centos-release</span><br><span class="line">centos-release-7-4.1708.el7.centos.x86_64</span><br></pre></td></tr></table></figure>
<h4 id="java版本"><a class="header-anchor" href="#java版本">¶</a>Java版本</h4>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@VM_0_11_centos /]# java -version</span><br><span class="line">openjdk version &quot;1.8.0_181&quot;</span><br><span class="line">OpenJDK Runtime Environment (build 1.8.0_181-b13)</span><br><span class="line">OpenJDK 64-Bit Server VM (build 25.181-b13, mixed mode)</span><br></pre></td></tr></table></figure>
<h4 id="maven版本"><a class="header-anchor" href="#maven版本">¶</a>Maven版本</h4>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@VM_0_11_centos /]# mvn -v</span><br><span class="line">Apache Maven 3.0.5 (Red Hat 3.0.5-17)</span><br><span class="line">Maven home: /usr/share/maven</span><br><span class="line">Java version: 1.8.0_181, vendor: Oracle Corporation</span><br><span class="line">Java home: /usr/lib/jvm/java-1.8.0-openjdk-1.8.0.181-3.b13.el7_5.x86_64/jre</span><br><span class="line">Default locale: en_US, platform encoding: UTF-8</span><br><span class="line">OS name: &quot;linux&quot;, version: &quot;3.10.0-693.el7.x86_64&quot;, arch: &quot;amd64&quot;, family: &quot;unix&quot;</span><br></pre></td></tr></table></figure>
<h4 id="git版本"><a class="header-anchor" href="#git版本">¶</a>Git版本</h4>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@VM_0_11_centos /]# git --version</span><br><span class="line">git version 1.8.3.1</span><br></pre></td></tr></table></figure>
<h2 id="二-安装"><a class="header-anchor" href="#二-安装">¶</a>二、安装</h2>
<h4 id="java安装"><a class="header-anchor" href="#java安装">¶</a>Java安装</h4>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install java-1.8.0-openjdk.x86_64</span><br></pre></td></tr></table></figure>
<h4 id="maven安装"><a class="header-anchor" href="#maven安装">¶</a>Maven安装</h4>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install maven</span><br></pre></td></tr></table></figure>
<h4 id="git安装"><a class="header-anchor" href="#git安装">¶</a>Git安装</h4>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install git</span><br></pre></td></tr></table></figure>
<h4 id="jenkins安装"><a class="header-anchor" href="#jenkins安装">¶</a>Jenkins安装</h4>
<p>rpm包地址：<a href="https://pkg.jenkins.io/redhat-stable/" target="_blank" rel="noopener">https://pkg.jenkins.io/redhat-stable/</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rpm -ivh xxx.npm</span><br></pre></td></tr></table></figure>
<p>执行以上指令后即安装完毕，查看一下jenkins所在目录</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">whereis jenkins</span><br></pre></td></tr></table></figure>
<p>控制台输出</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@VM_0_11_centos /]# whereis jenkins</span><br><span class="line">jenkins: /usr/lib/jenkins</span><br></pre></td></tr></table></figure>
<p>默认jenkins的配置文件在<code>/etc/sysconfig/jenkins</code></p>
<p>启动jenkins</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">service jenkins start</span><br></pre></td></tr></table></figure>
<p>关闭jenkins</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">service jenkins stop</span><br></pre></td></tr></table></figure>
<h2 id="三-jenkins部署maven项目"><a class="header-anchor" href="#三-jenkins部署maven项目">¶</a>三、Jenkins部署Maven项目</h2>
<p>Jenkins启动只有的默认端口为8080，在保证服务器安全组开放8080端口（或者自己在<code>/etc/sysconfig/jenkins</code>配置文件中修改端口）的前提下，我们可以直接通过浏览器访问Jenkins</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://xxxxxx:8080</span><br></pre></td></tr></table></figure>
<p>第一次进入Jenkins会让你走几个步骤</p>
<ul>
<li>输入管理员密码，密码可以从页面提示的文件中看到</li>
<li>下载默认插件，点击官方推荐的按钮继续往下走</li>
<li>设置账号密码和邮箱地址</li>
<li>登入</li>
</ul>
<p>一顿操作，我们就来到了Jenkins的Dashboard页面<br>
<img src="https://user-gold-cdn.xitu.io/2018/11/6/166e77b6974344c0?w=1897&amp;h=598&amp;f=png&amp;s=72196" alt="这里写图片描述"></p>
<p>看到这里是不是很激动？别急，Jenkins的新建任务默认是没有Maven选项的,需要自行安装Jenkins的Maven插件！</p>
<h4 id="1-安装jenkins-maven插件maven-integration"><a class="header-anchor" href="#1-安装jenkins-maven插件maven-integration">¶</a>1、安装Jenkins-Maven插件Maven Integration</h4>
<p>在首页中点击右侧的系统管理<br>
<img src="https://user-gold-cdn.xitu.io/2018/11/6/166e77b6976b76bd?w=1885&amp;h=613&amp;f=png&amp;s=75878" alt="这里写图片描述"><br>
选择管理插件<br>
<img src="https://user-gold-cdn.xitu.io/2018/11/6/166e77b697a978f8?w=1892&amp;h=862&amp;f=png&amp;s=133614" alt="这里写图片描述"><br>
下载Maven Integration<br>
<img src="https://user-gold-cdn.xitu.io/2018/11/6/166e77b6979cd7a5?w=1892&amp;h=651&amp;f=png&amp;s=67831" alt="这里写图片描述"><br>
点击立即获取之后，等待一分钟左右就下载好了</p>
<h4 id="2-配置全局工具"><a class="header-anchor" href="#2-配置全局工具">¶</a>2、配置全局工具</h4>
<p>接着我们要做一些工具的配置</p>
<p>再次进入系统管理，点击列表中的<strong>全局工具配置</strong><br>
<img src="https://user-gold-cdn.xitu.io/2018/11/6/166e77b69783f279?w=1889&amp;h=827&amp;f=png&amp;s=128413" alt="这里写图片描述"><br>
配置JDK<br>
<img src="https://user-gold-cdn.xitu.io/2018/11/6/166e77b697743f0a?w=1529&amp;h=362&amp;f=png&amp;s=20752" alt="这里写图片描述"><br>
配置Git<br>
<img src="https://user-gold-cdn.xitu.io/2018/11/6/166e77b6c277f7c6?w=1523&amp;h=320&amp;f=png&amp;s=17690" alt="这里写图片描述"><br>
配置Maven<br>
<img src="https://user-gold-cdn.xitu.io/2018/11/6/166e77b6c740707d?w=1507&amp;h=331&amp;f=png&amp;s=19931" alt="这里写图片描述"><br>
完毕之后点击<code>SAVE</code>按钮保存</p>
<h4 id="3-配置任务信息"><a class="header-anchor" href="#3-配置任务信息">¶</a>3、配置任务信息</h4>
<p>经过前面两个步骤，我们的Jenkins可以正式开始工作了，不过在真正为我们提供服务之前，我们需要告诉任务该做什么事情，该怎么做。</p>
<p>例如？我们要构建的项目从何而来？通过什么样的方式或者指令就构建？不废话，开始创建一个新的任务，并且是一个Maven项目<br>
<img src="https://user-gold-cdn.xitu.io/2018/11/6/166e77b6c7c0c77f?w=1901&amp;h=614&amp;f=png&amp;s=60467" alt="这里写图片描述"><br>
点击创建一个新任务进入下一步<br>
<img src="https://user-gold-cdn.xitu.io/2018/11/6/166e77b6ca5adfa0?w=1852&amp;h=933&amp;f=png&amp;s=132108" alt="这里写图片描述"><br>
选择创建一个Maven项目，确定之后，进入任务配置界面</p>
<p>任务信息配置<br>
<img src="https://user-gold-cdn.xitu.io/2018/11/6/166e77b6d06d8e2b?w=1882&amp;h=462&amp;f=png&amp;s=42624" alt="这里写图片描述"><br>
源码库配置，Jenkins要知道如何获取到项目的源码<br>
<img src="https://user-gold-cdn.xitu.io/2018/11/6/166e77b6d2fca2f2?w=1887&amp;h=657&amp;f=png&amp;s=63920" alt="这里写图片描述"><br>
Maven打包指令配置<br>
<img src="https://user-gold-cdn.xitu.io/2018/11/6/166e77b6e4036b64?w=1886&amp;h=425&amp;f=png&amp;s=37257" alt="这里写图片描述"><br>
构建策略配置<br>
<img src="https://user-gold-cdn.xitu.io/2018/11/6/166e77b6eb145739?w=1879&amp;h=374&amp;f=png&amp;s=43226" alt="这里写图片描述"><br>
<img src="https://user-gold-cdn.xitu.io/2018/11/6/166e77b6f1a7a410?w=1889&amp;h=327&amp;f=png&amp;s=33364" alt="这里写图片描述"><br>
构建生命周期配置<br>
<img src="https://user-gold-cdn.xitu.io/2018/11/6/166e77b6f5b10abc?w=1884&amp;h=726&amp;f=png&amp;s=76468" alt="这里写图片描述"><br>
这一步很关键，在Jenkins帮我们自动拉取代码并且打成jar包之后，我们需要执行shell指令去启动它们，<code>Pre Steps</code>和<code>Post Steps</code>使我们可以在整个周期内灵活的去控制流程~例如写个脚本启动它们！</p>
<p>简单配置之后，点击保存，完成任务配置编辑！</p>
<p>之后的事情就简单了，在首页可以看到一个任务列表，选中自己的任务点击进入<br>
<img src="https://user-gold-cdn.xitu.io/2018/11/6/166e77b6fa1e7b0f?w=1890&amp;h=567&amp;f=png&amp;s=67414" alt="这里写图片描述"><br>
点击左侧工具栏的立即构建~<br>
<img src="https://user-gold-cdn.xitu.io/2018/11/6/166e77b6fc49a77e?w=1891&amp;h=879&amp;f=png&amp;s=108676" alt="这里写图片描述"><br>
Jenkins简单部署完成，看下我的任务构建控制台输出日志<br>
<img src="https://user-gold-cdn.xitu.io/2018/11/6/166e77b7806857f7?w=1883&amp;h=907&amp;f=png&amp;s=90364" alt="这里写图片描述"></p>
<p>看到最下方的成功就代表项目已经成功部署！</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="https://avatars1.githubusercontent.com/u/26395860?s=460&v=4" alt="Nico">
            
              <p class="site-author-name" itemprop="name">Nico</p>
              <p class="site-description motion-element" itemprop="description">我是Nico，梦想是做一名兴趣使然的码农，于是我一步步变强，后来我成为了光头</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">14</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                
                  <span class="site-state-item-count">4</span>
                  <span class="site-state-item-name">分类</span>
                
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                
                  <span class="site-state-item-count">5</span>
                  <span class="site-state-item-name">标签</span>
                
              </div>
            

          </nav>

          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/ainilili" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i>GitHub</a>
                  </span>
                
            </div>
          

          
          

          
          
            <div class="links-of-blogroll motion-element links-of-blogroll-block">
              <div class="links-of-blogroll-title">
                <i class="fa  fa-fw fa-link"></i>
                友链
              </div>
              <ul class="links-of-blogroll-list">
                
                  <li class="links-of-blogroll-item">
                    <a href="http://note.isnico.com/" title="Nico's笔记" target="_blank">Nico's笔记</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://blog.abby.md/" title="Abby's博客" target="_blank">Abby's博客</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://zhangsan.plus/" title="ZhangSan_Plus'博客" target="_blank">ZhangSan_Plus'博客</a>
                  </li>
                
              </ul>
            </div>
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">小Nico</span>

  
</div>
        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
